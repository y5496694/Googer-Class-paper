<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 초등 학습지 & 책 만들기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap');
        body { font-family: 'Gowun Dodum', sans-serif; }
        .loader { border: 8px solid #f3f3f3; border-radius: 50%; width: 60px; height: 60px; animation: spin 2s linear infinite; }
        .loader.korean { border-top: 8px solid #3498db; }
        .loader.math { border-top: 8px solid #ef4444; }
        .loader.book { border-top: 8px solid #10b981; }
        .loader.dictation { border-top: 8px solid #14b8a6; }
        .loader.word { border-top: 8px solid #8b5cf6; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .tts-word { cursor: pointer; transition: color 0.2s; }
        .tts-word:hover { color: #3b82f6; }
        
        .korean-tts-btn { position: absolute; left: -1.75rem; width: 1.5rem; height: 1.5rem; background-color: #3b82f6; color: white; border-radius: 9999px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; cursor: pointer; }
        .paragraph-tts { top: 0.5rem; }
        .question-tts { top: 0.25rem; }
        .title-tts { top: 0.5rem; }

        .book-viewer { aspect-ratio: 2 / 1.414; width: 100%; display: flex; }
        .book-page { position: relative; width: 50%; height: 100%; background-size: cover; background-position: center; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 2rem; box-sizing: border-box; }
        .book-spread { display: none; }
        .book-spread.active { display: flex; }
        .text-box { background-color: rgba(255, 255, 255, 0.85); border: 2px solid black; padding: 1rem; text-align: center; }
        .page-nav { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(0,0,0,0.5); color: white; border: none; border-radius: 9999px; width: 3rem; height: 3rem; font-size: 2rem; cursor: pointer; z-index: 10; }
        .page-number { position: absolute; bottom: 0.5rem; font-size: 0.875rem; color: #374151; }
        .manual-text-area { width: 100%; height: 80%; background: transparent; border: 2px dashed #ccc; border-radius: 8px; padding: 1rem; text-align: left; overflow-y: auto; }
        .text-hidden, .text-hidden .tts-word { color: transparent !important; }
        .text-box.text-hidden { background-color: rgba(255, 255, 255, 0) !important; border-color: transparent !important; }
        .answer-hidden { color: transparent; user-select: none; }
        .hangul-btn { transition: background-color 0.2s, transform 0.1s; }
        .hangul-btn:hover { background-color: #e0e7ff; }
        .hangul-btn:active { transform: scale(0.95); }
        .quiz-btn[data-quiz-state="1"] { background-color: rgba(251, 146, 60, 0.8) !important; } /* 주황색 */
        .quiz-btn[data-quiz-state="2"] { background-color: rgba(239, 68, 68, 0.8) !important; } /* 빨간색 */
    </style>
</head>
<body class="p-2 md:p-8 bg-gray-100">

    <div id="app-container">
        <!-- 국어 활동지 페이지 -->
        <div id="korean-page" class="page-content max-w-4xl mx-auto">
             <div class="bg-white rounded-2xl shadow-lg p-6 md:p-10">
                 <header class="flex flex-wrap justify-between items-center gap-4 mb-8">
                     <h1 class="text-2xl md:text-4xl font-bold text-gray-800">AI 초등 국어 활동지</h1>
                     <div class="flex flex-wrap gap-2">
                         <button onclick="showPage('dictation')" class="bg-teal-200 text-teal-700 font-bold py-2 px-4 rounded-lg hover:bg-teal-300 transition">AI 받아쓰기 →</button>
                         <button onclick="showPage('word')" class="bg-violet-200 text-violet-700 font-bold py-2 px-4 rounded-lg hover:bg-violet-300 transition">낱말 활동지 →</button>
                         <button onclick="showPage('book-creator')" class="bg-emerald-200 text-emerald-700 font-bold py-2 px-4 rounded-lg hover:bg-emerald-300 transition">책 만들기 →</button>
                         <button onclick="showPage('math')" class="bg-rose-200 text-rose-700 font-bold py-2 px-4 rounded-lg hover:bg-rose-300 transition">AI 수학 문제 →</button>
                     </div>
                 </header>
                 <div id="korean-input-section" class="bg-blue-50 p-6 rounded-xl flex flex-col md:flex-row items-center gap-4">
                     <div class="w-full"><label for="topic" class="block text-lg font-semibold text-gray-700 mb-1">글의 주제</label><input type="text" id="topic" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="예: 우주, 강아지"></div>
                     <div class="w-full md:w-1/3"><label for="word_count" class="block text-lg font-semibold text-gray-700 mb-1">단어 수</label><input type="number" id="word_count" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="예: 200"></div>
                     <button id="korean-generate-btn" onclick="generateKoreanWorksheet()" class="w-full md:w-auto mt-4 md:mt-7 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg">활동지 만들기</button>
                 </div>
                 <div id="korean-loading-section" class="text-center py-12 hidden"><div class="loader korean inline-block"></div><p class="text-lg text-gray-700 mt-4">AI가 열심히 글을 쓰고 그림을 그리고 있어요...</p></div>
                 <div id="korean-error-section" class="text-center py-8 hidden"><p class="text-xl text-red-600 font-semibold">😥 생성 실패</p><p id="korean-error-message" class="text-gray-600 mt-2"></p></div>
                 <div id="korean-worksheet-area" class="mt-8"></div>
                 <div id="korean-action-buttons" class="text-center mt-10 hidden"><button id="download-pdf-korean" onclick="downloadPDF('korean-worksheet-area')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg">PDF로 저장하기</button></div>
             </div>
        </div>

        <!-- 받아쓰기 페이지 -->
        <div id="dictation-page" class="page-content max-w-4xl mx-auto hidden">
            <div class="bg-teal-50 rounded-2xl shadow-lg p-6 md:p-10">
                <header class="flex justify-between items-center mb-8"><h1 class="text-2xl md:text-4xl font-bold text-teal-800">AI 받아쓰기</h1><button onclick="showPage('korean')" class="bg-blue-200 text-blue-700 font-bold py-2 px-4 rounded-lg hover:bg-blue-300 transition">← AI 국어 활동지</button></header>
                <div id="dictation-input-section" class="bg-white p-6 rounded-xl space-y-4">
                    <div class="flex justify-center gap-6 mb-4">
                        <label class="flex items-center text-lg"><input type="radio" name="dictationType" value="sentence" checked class="h-4 w-4 text-teal-600 border-gray-300 focus:ring-teal-500"><span class="ml-2">문장</span></label>
                        <label class="flex items-center text-lg"><input type="radio" name="dictationType" value="word" class="h-4 w-4 text-teal-600 border-gray-300 focus:ring-teal-500"><span class="ml-2">단어</span></label>
                    </div>
                    <div class="flex flex-col md:flex-row items-center gap-4">
                        <div class="w-full"><label for="dictation-topic" class="block text-lg font-semibold text-gray-700 mb-1">받아쓰기 주제</label><input type="text" id="dictation-topic" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="예: 동물, 우리나라"></div>
                        <div class="w-full md:w-1/3"><label for="dictation-count" class="block text-lg font-semibold text-gray-700 mb-1">문항 개수</label><input type="number" id="dictation-count" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="예: 10"></div>
                        <button id="dictation-generate-btn" onclick="generateDictation()" class="w-full md:w-auto self-end bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-8 rounded-lg">생성</button>
                    </div>
                </div>
                <div id="dictation-loading-section" class="text-center py-12 hidden"><div class="loader dictation inline-block"></div><p class="text-lg text-teal-700 mt-4">AI가 받아쓰기 문제를 만들고 있어요...</p></div>
                <div id="dictation-error-section" class="text-center py-8 hidden"><p class="text-xl text-red-600 font-semibold">😥 생성 실패</p><p id="dictation-error-message" class="text-gray-600 mt-2"></p></div>
                <div id="dictation-area" class="mt-8 space-y-4"></div>
                <div id="dictation-results-section" class="mt-10 text-center hidden"><button onclick="revealDictationAnswers()" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-6 rounded-lg">정답 공개</button></div>
            </div>
        </div>

        <!-- 낱말 활동지 페이지 -->
        <div id="word-page" class="page-content max-w-7xl mx-auto hidden">
            <div class="bg-violet-50 rounded-2xl shadow-lg p-6 md:p-10">
                <header class="flex justify-between items-center mb-8"><h1 class="text-2xl md:text-4xl font-bold text-violet-800">낱말 활동지</h1><button onclick="showPage('korean')" class="bg-blue-200 text-blue-700 font-bold py-2 px-4 rounded-lg hover:bg-blue-300 transition">← AI 국어 활동지</button></header>
                <div class="mt-8 bg-white p-4 md:p-6 rounded-lg overflow-x-auto">
                    <p class="text-lg text-gray-700 mb-4">자음과 모음이 만나 어떤 소리가 나는지 눌러서 확인해보세요! 필요 없는 자음/모음은 <span class="text-red-500 font-bold">×</span> 버튼으로 삭제할 수 있습니다.</p>
                    <div class="flex justify-center flex-wrap gap-4 mb-4 border-b pb-4">
                        <div class="flex rounded-lg shadow-sm">
                            <button id="single-vowel-btn" onclick="setVowelType('single')" class="font-bold py-2 px-6 rounded-l-lg">단모음</button>
                            <button id="double-vowel-btn" onclick="setVowelType('double')" class="font-bold py-2 px-6 rounded-r-lg">이중모음</button>
                        </div>
                         <div class="flex rounded-lg shadow-sm">
                            <button id="tense-exclude-btn" onclick="setTenseInclusion(false)" class="font-bold py-2 px-6 rounded-l-lg">된소리 제거</button>
                            <button id="tense-include-btn" onclick="setTenseInclusion(true)" class="font-bold py-2 px-6 rounded-r-lg">된소리 추가</button>
                        </div>
                    </div>
                    <div id="hangul-table-container"></div>
                    <div class="mt-6 text-center">
                        <button onclick="startHangulQuiz()" class="bg-orange-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-orange-600 inline-flex items-center gap-2">
                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><path d="M10 10.3c.2-.4.5-.8.9-1a2.1 2.1 0 0 1 2.6.4c.3.4.5.8.5 1.3 0 1.3-2 2-2 2"/><path d="M12 17h.01"/></svg>
                           자모음표 퀴즈
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 퀴즈 페이지 -->
        <div id="quiz-page" class="page-content max-w-7xl mx-auto hidden">
            <div class="bg-orange-50 rounded-2xl shadow-lg p-6 md:p-10">
                 <header class="flex justify-between items-center mb-4">
                     <h1 class="text-2xl md:text-4xl font-bold text-orange-800">자모음표 퀴즈</h1>
                     <div class="flex items-center gap-2">
                         <label for="quiz-name" class="font-semibold">이름:</label>
                         <input type="text" id="quiz-name" class="p-2 border rounded-lg" placeholder="이름 입력">
                         <button onclick="showPage('word')" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">← 돌아가기</button>
                     </div>
                 </header>
                 <div id="quiz-table-container" class="mt-4 bg-white p-4 md:p-6 rounded-lg overflow-x-auto"></div>
                 <div class="mt-6 text-center">
                     <button onclick="gradeQuiz()" class="bg-orange-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-orange-600">채점하기</button>
                 </div>
                 <div id="quiz-result-area" class="mt-8"></div>
            </div>
        </div>

        <!-- 수학 문제 페이지 -->
        <div id="math-page" class="page-content max-w-4xl mx-auto hidden">
            <div class="bg-rose-50 rounded-2xl shadow-lg p-6 md:p-10">
                <header class="flex justify-between items-center mb-8"><h1 class="text-2xl md:text-4xl font-bold text-rose-800">AI 수학 문장제 문제</h1><button onclick="showPage('korean')" class="bg-blue-200 text-blue-700 font-bold py-2 px-4 rounded-lg hover:bg-blue-300 transition">← AI 국어 활동지</button></header>
                <div id="math-input-section" class="bg-white p-6 rounded-xl flex flex-col md:flex-row items-center gap-4">
                     <div class="w-full"><label for="math-example" class="block text-lg font-semibold text-gray-700 mb-1">문제 예시</label><input type="text" id="math-example" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="예: 사과 3개와 배 2개를 더하는 문제"></div>
                    <div class="w-full md:w-1/3"><label for="math-count" class="block text-lg font-semibold text-gray-700 mb-1">문제 수</label><input type="number" id="math-count" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="예: 5"></div>
                    <button id="math-generate-btn" onclick="generateMathProblems()" class="w-full md:w-auto mt-4 md:mt-7 bg-rose-600 hover:bg-rose-700 text-white font-bold py-3 px-8 rounded-lg">문제 만들기</button>
                </div>
                <div id="math-loading-section" class="text-center py-12 hidden"><div class="loader math inline-block"></div><p class="text-lg text-rose-700 mt-4">AI가 열심히 문제를 만들고 있어요...</p></div>
                <div id="math-error-section" class="text-center py-8 hidden"><p class="text-xl text-red-600 font-semibold">😥 생성 실패</p><p id="math-error-message" class="text-gray-600 mt-2"></p></div>
                <div id="math-problems-area" class="mt-8 space-y-6"></div>
                <div id="math-results-section" class="mt-10 text-center hidden"><div class="bg-white inline-flex items-center gap-4 p-4 rounded-xl shadow"><span class="text-2xl font-bold text-rose-800">총점: <span id="total-score">0</span>점</span><button onclick="gradeAll()" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-6 rounded-lg">전체 채점</button></div></div>
            </div>
        </div>
        
        <!-- 책 만들기 페이지 -->
        <div id="book-creator-page" class="page-content max-w-4xl mx-auto hidden">
             <div class="bg-emerald-50 rounded-2xl shadow-lg p-6 md:p-10">
                <header class="flex justify-between items-center mb-8"><h1 class="text-2xl md:text-4xl font-bold text-emerald-800">AI 동화책 만들기</h1><button onclick="showPage('korean')" class="bg-blue-200 text-blue-700 font-bold py-2 px-4 rounded-lg hover:bg-blue-300 transition">← AI 국어 활동지</button></header>
                <div id="book-input-section" class="bg-white p-6 rounded-xl space-y-4">
                    <p class="text-lg font-semibold text-gray-800">AI에게 동화책 제작을 맡겨보세요!</p>
                    <div><label for="book-topic" class="block text-lg font-semibold text-gray-700 mb-1">글의 주제</label><input type="text" id="book-topic" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="예: 용감한 토끼의 모험"></div>
                    <div><label for="book-title" class="block text-lg font-semibold text-gray-700 mb-1">글의 제목</label><input type="text" id="book-title" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="예: 숲속의 작은 영웅"></div>
                    <div><label for="book-plot" class="block text-lg font-semibold text-gray-700 mb-1">간단한 줄거리</label><textarea id="book-plot" class="w-full p-3 border border-gray-300 rounded-lg" rows="3" placeholder="예: 작은 토끼가 무서운 늑대를 꾀를 내어 물리치고 숲의 영웅이 되는 이야기"></textarea></div>
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="w-full"><label for="book-sheets" class="block text-lg font-semibold text-gray-700 mb-1">장 수 (3장 이상)</label><input type="number" id="book-sheets" min="3" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="예: 5"></div>
                        <div class="w-full"><label for="book-author" class="block text-lg font-semibold text-gray-700 mb-1">글쓴이</label><input type="text" id="book-author" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="예: 홍길동"></div>
                    </div>
                    <div class="mt-4 flex items-center">
                        <input id="empty-content-checkbox" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500">
                        <label for="empty-content-checkbox" class="ml-2 block text-sm text-gray-900">내용 비우기 기능 (내용 직접 써보기)</label>
                    </div>
                    <button id="book-generate-btn" onclick="generateBook()" class="w-full mt-2 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-8 rounded-lg">AI로 책 만들기</button>
                    <div class="border-t my-6"></div>
                    <p class="text-lg font-semibold text-gray-800">또는, 모든 내용을 직접 만들어보세요!</p>
                    <button onclick="startManualBookCreation()" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-8 rounded-lg">내가 직접 책 만들기</button>
                </div>
                <div id="book-loading-section" class="text-center py-12 hidden"><div class="loader book inline-block"></div><p class="text-lg text-emerald-700 mt-4">AI가 동화책을 만들고 있어요. 잠시만 기다려 주세요...</p></div>
                <div id="book-error-section" class="text-center py-8 hidden"><p class="text-xl text-red-600 font-semibold">😥 생성 실패</p><p id="book-error-message" class="text-gray-600 mt-2"></p></div>
             </div>
        </div>

        <div id="book-viewer-page" class="page-content max-w-7xl mx-auto hidden">
            <div class="bg-white rounded-2xl shadow-lg p-4 md:p-6">
                <div id="viewer-controls" class="flex justify-between items-center mb-4">
                    <button onclick="showPage('book-creator')" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">← 뒤로 가기</button>
                    <div id="manual-controls" class="hidden items-center gap-2">
                         <button onclick="addManualPage()" class="bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-600">+ 페이지 추가</button>
                         <button onclick="completeManualBook()" class="bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-700">책 완성하기</button>
                    </div>
                    <div id="standard-controls" class="flex items-center gap-4">
                        <div class="flex items-center">
                            <input id="toggle-text-visibility-checkbox" type="checkbox" onchange="toggleTextVisibility()" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="toggle-text-visibility-checkbox" class="ml-2 block text-sm text-gray-900">내용 비우기</label>
                        </div>
                        <button id="edit-book-btn" onclick="toggleBookEdit()" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600">글 편집</button>
                        <button id="save-book-pdf-btn" onclick="downloadBookAsPDF()" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">PDF 저장</button>
                    </div>
                </div>
                <div id="book-viewer" class="relative"></div>
                <div id="manual-book-context-wrapper" class="hidden mt-4">
                    <label for="manual-book-context" class="block text-lg font-semibold text-gray-700 mb-2">🎨 그림 생성할 때 AI가 알아야 할 내용</label>
                    <textarea id="manual-book-context" class="w-full p-3 border border-gray-300 rounded-lg" rows="3" placeholder="예: 책상 왕자는 사람이 아니라 책상에 눈, 코, 입이 달린 의인화된 생물이야."></textarea>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수 및 상수
        const GEMINI_API_KEY = "AIzaSyC7_Gq4LIVVMv0hMD6qSwcTlGJcDSt-KgI";
        const STABILITY_API_KEY = "sk-1O2c3lhxjfCfQizxRNllhxgEa8jJiNw01ebyzIOadQFFmdh1";
        const TEXT_MODEL = "gemini-2.0-flash";
        
        let mathProblems = [], bookCurrentPage = 0, totalBookSpreads = 0, isManualBookMode = false;

        // 낱말 활동지 관련 전역 변수
        let currentVowelType = 'single', includeTense = false;
        let activeConsonants = [], activeVowels = [], deletedConsonants = [], deletedVowels = [];

        // 한글 자모 상수
        const CHO_ALL = ['ㄱ', 'ㄲ', 'ㄴ', 'ㄷ', 'ㄸ', 'ㄹ', 'ㅁ', 'ㅂ', 'ㅃ', 'ㅅ', 'ㅆ', 'ㅇ', 'ㅈ', 'ㅉ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'];
        const CHO_BASIC = ['ㄱ', 'ㄴ', 'ㄷ', 'ㄹ', 'ㅁ', 'ㅂ', 'ㅅ', 'ㅇ', 'ㅈ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'];
        const JUNG_ALL = ['ㅏ', 'ㅐ', 'ㅑ', 'ㅒ', 'ㅓ', 'ㅔ', 'ㅕ', 'ㅖ', 'ㅗ', 'ㅘ', 'ㅙ', 'ㅚ', 'ㅛ', 'ㅜ', 'ㅝ', 'ㅞ', 'ㅟ', 'ㅠ', 'ㅡ', 'ㅢ', 'ㅣ'];
        const JUNG_SINGLE = ['ㅏ', 'ㅑ', 'ㅓ', 'ㅕ', 'ㅗ', 'ㅛ', 'ㅜ', 'ㅠ', 'ㅡ', 'ㅣ'];
        const JUNG_DOUBLE = ['ㅐ', 'ㅒ', 'ㅔ', 'ㅖ', 'ㅘ', 'ㅙ', 'ㅚ', 'ㅝ', 'ㅞ', 'ㅟ', 'ㅢ'];

        // 유틸리티 및 공통 함수
        function showPage(pageId) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            document.getElementById(`${pageId}-page`).classList.remove('hidden');
            window.scrollTo(0, 0);
            if (pageId === 'word') {
                // '낱말 활동지' 페이지로 올 때마다 상태 초기화
                setVowelType('single');
                setTenseInclusion(false);
            }
        }
        function speak(text) { if (window.speechSynthesis) { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); u.lang = 'ko-KR'; u.rate = 0.9; window.speechSynthesis.speak(u); } }

        // 낱말 활동지 & 퀴즈 로직 (자모음표 관리)
        function resetHangulState() {
            activeConsonants = includeTense ? [...CHO_ALL] : [...CHO_BASIC];
            activeVowels = currentVowelType === 'single' ? [...JUNG_SINGLE] : [...JUNG_DOUBLE];
            deletedConsonants = [];
            deletedVowels = [];
        }

        function deleteConsonant(consonant) {
            const index = activeConsonants.indexOf(consonant);
            if (index > -1) {
                activeConsonants.splice(index, 1);
                if (!deletedConsonants.includes(consonant)) deletedConsonants.push(consonant);
                generateHangulTable(false);
            }
        }

        function deleteVowel(vowel) {
            const index = activeVowels.indexOf(vowel);
            if (index > -1) {
                activeVowels.splice(index, 1);
                if (!deletedVowels.includes(vowel)) deletedVowels.push(vowel);
                generateHangulTable(false);
            }
        }
        
        function setVowelType(type) { 
            currentVowelType = type; 
            resetHangulState();
            updateHangulTableButtons(); 
            generateHangulTable(false); 
        }
        function setTenseInclusion(include) { 
            includeTense = include; 
            resetHangulState();
            updateHangulTableButtons(); 
            generateHangulTable(false); 
        }

        function updateHangulTableButtons() {
            const btnConfigs = {
                'single-vowel-btn': { active: currentVowelType === 'single', color: 'violet' },
                'double-vowel-btn': { active: currentVowelType === 'double', color: 'violet' },
                'tense-exclude-btn': { active: !includeTense, color: 'indigo' },
                'tense-include-btn': { active: includeTense, color: 'indigo' }
            };
            for (const [id, config] of Object.entries(btnConfigs)) {
                const btn = document.getElementById(id);
                btn.classList.toggle(`bg-${config.color}-600`, config.active);
                btn.classList.toggle('text-white', config.active);
                btn.classList.toggle('bg-white', !config.active);
                btn.classList.toggle(`text-${config.color}-600`, !config.active);
                btn.classList.toggle('border', !config.active);
                btn.classList.toggle(`border-${config.color}-600`, !config.active);
            }
        }
        function generateHangulTable(isQuiz = false) {
            const container = document.getElementById(isQuiz ? 'quiz-table-container' : 'hangul-table-container');
            container.innerHTML = ''; 

            const consonantsToShow = activeConsonants;
            const vowelsToShow = activeVowels;
            
            const table = document.createElement('table'); table.className = 'w-full border-collapse text-center';
            const thead = table.createTHead(); const headerRow = thead.insertRow(); headerRow.className = 'bg-violet-100';
            
            const emptyCell = headerRow.insertCell(); emptyCell.className = 'p-1 md:p-2 border border-violet-200';
            
            vowelsToShow.forEach(vowel => { 
                const th = document.createElement('th'); 
                th.className = 'p-1 md:p-2 border border-violet-200 align-top';
                th.innerHTML = `
                    ${!isQuiz ? `<button onclick="deleteVowel('${vowel}')" class="block mx-auto text-red-500 hover:bg-red-100 rounded-full w-5 h-5 flex items-center justify-center font-bold text-sm mb-1">×</button>` : ''}
                    <button onclick="${isQuiz ? '' : `speak('${vowel}')`}" class="hangul-btn w-full h-full text-base md:text-lg font-bold text-violet-800">${vowel}</button>
                `;
                headerRow.appendChild(th); 
            });

            const tbody = table.createTBody();
            consonantsToShow.forEach(consonant => {
                const row = tbody.insertRow(); 
                const consonantCell = row.insertCell(); 
                consonantCell.className = 'p-1 md:p-2 border border-violet-200 bg-violet-100';
                consonantCell.innerHTML = `
                    <div class="flex items-center justify-start w-full">
                        ${!isQuiz ? `<button onclick="deleteConsonant('${consonant}')" class="text-red-500 hover:bg-red-100 rounded-full w-5 h-5 flex items-center justify-center font-bold text-sm mr-1 flex-shrink-0">×</button>` : ''}
                        <button onclick="${isQuiz ? '' : `speak('${consonant}')`}" class="hangul-btn flex-grow text-center text-base md:text-lg font-bold text-violet-800">${consonant}</button>
                    </div>
                `;

                vowelsToShow.forEach(vowel => {
                    const syllableCell = row.insertCell(); 
                    syllableCell.className = 'p-1 md:p-2 border border-violet-200';
                    const choIndex = CHO_ALL.indexOf(consonant); 
                    const jungIndex = JUNG_ALL.indexOf(vowel);
                    if (choIndex !== -1 && jungIndex !== -1) {
                        const syllable = String.fromCharCode(0xAC00 + choIndex * 21 * 28 + jungIndex * 28);
                        syllableCell.innerHTML = `<button onclick="${isQuiz ? 'handleQuizCellClick(this)' : `speak('${syllable}')`}" class="hangul-btn ${isQuiz ? 'quiz-btn' : ''} w-full h-full text-base md:text-lg" data-quiz-state="0">${syllable}</button>`;
                    }
                });
            });
            container.appendChild(table);
        }

        function startHangulQuiz() { generateHangulTable(true); showPage('quiz'); document.getElementById('quiz-result-area').innerHTML = '';}
        function handleQuizCellClick(btn) { let state = parseInt(btn.dataset.quizState); state = (state + 1) % 3; btn.dataset.quizState = state; }
        function gradeQuiz() {
            const name = document.getElementById('quiz-name').value || '학생';
            const date = new Date().toLocaleString('ko-KR');
            const results = { correct: [], practice: [], study: [] };
            document.querySelectorAll('#quiz-table-container .quiz-btn').forEach(btn => {
                const state = parseInt(btn.dataset.quizState);
                if (state === 0) results.correct.push(btn.textContent);
                else if (state === 1) results.practice.push(btn.textContent);
                else if (state === 2) results.study.push(btn.textContent);
            });
            const totalCount = results.correct.length + results.practice.length + results.study.length;
            const score = totalCount > 0 ? Math.round((results.correct.length / totalCount) * 100) : 0;
            
            let deletedString = '';
            if (deletedConsonants.length > 0) {
                deletedString += ` <br><span class="text-xs">(삭제 자음: ${deletedConsonants.sort().join(', ')})</span>`;
            }
            if (deletedVowels.length > 0) {
                deletedString += ` <br><span class="text-xs">(삭제 모음: ${deletedVowels.sort().join(', ')})</span>`;
            }
            const quizTypeString = `유형: ${currentVowelType === 'single' ? '단모음' : '이중모음'} (${includeTense ? '된소리 O' : '된소리 X'}) ${deletedString}`;

            const resultArea = document.getElementById('quiz-result-area');
            resultArea.innerHTML = `
                <div id="quiz-result-content" class="mt-8 bg-white p-6 rounded-lg shadow-inner">
                    <h3 class="text-2xl font-bold text-center text-orange-800 mb-4">채점 결과</h3>
                    <p class="text-md text-gray-600"><strong>날짜:</strong> ${date}</p>
                    <p class="text-md text-gray-600"><strong>이름:</strong> ${name}</p>
                    <p class="text-md text-gray-600 mb-2"><strong>${quizTypeString}</strong></p>
                    <p class="text-xl font-bold mt-4 mb-2">총점: ${score}점</p>
                    <div class="space-y-2">
                        <p><strong><span class="text-green-600">정답 (${results.correct.length}개)</span>:</strong> ${results.correct.join(', ') || '없음'}</p>
                        <p><strong><span class="text-orange-500">연습 (${results.practice.length}개)</span>:</strong> ${results.practice.join(', ') || '없음'}</p>
                        <p><strong><span class="text-red-500">공부 (${results.study.length}개)</span>:</strong> ${results.study.join(', ') || '없음'}</p>
                    </div>
                </div>
                <div class="mt-4 text-center">
                    <button onclick="downloadQuizResult()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg">이미지로 다운로드</button>
                </div>
            `;
        }
        function downloadQuizResult() { const element = document.getElementById('quiz-result-content'); html2canvas(element, {scale: 2}).then(canvas => { const link = document.createElement('a'); link.download = '자모음표_퀴즈결과.png'; link.href = canvas.toDataURL(); link.click(); }); }
        
        // 받아쓰기 로직
        async function generateDictation(){
            const topic = document.getElementById("dictation-topic").value;
            const count = document.getElementById("dictation-count").value;
            const type = document.querySelector('input[name="dictationType"]:checked').value;
            if(!topic||!count)return void alert("주제와 문항 개수를 모두 입력해주세요!");
            const loadingSection=document.getElementById("dictation-loading-section"),errorSection=document.getElementById("dictation-error-section"),dictationArea=document.getElementById("dictation-area"),resultsSection=document.getElementById("dictation-results-section");
            loadingSection.classList.remove("hidden"),errorSection.classList.add("hidden"),dictationArea.innerHTML="",resultsSection.classList.add("hidden");
            try{
                const prompt="sentence"===type?`'${topic}'(이)라는 주제로 초등학생용 받아쓰기 문장을 ${count}개 만들어줘. 짧고 간단한 문장으로 부탁해.`:`'${topic}'(이)라는 주제와 관련된, 초등학생용 받아쓰기 단어를 ${count}개 만들어줘.`;
                const payload={contents:[{role:"user",parts:[{text:prompt}]}],generationConfig:{responseMimeType:"application/json",responseSchema:{type:"OBJECT",properties:{items:{type:"ARRAY",items:{type:"STRING"}}},required:["items"]}}},
                response=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
                if(!response.ok)throw new Error(`받아쓰기 생성 API 오류: ${response.statusText}`);
                const result=await response.json();if(!result.candidates?.[0]?.content?.parts?.[0]?.text)throw new Error("받아쓰기 생성 API로부터 유효한 데이터를 받지 못했습니다.");
                const {items}=JSON.parse(result.candidates[0].content.parts[0].text);
                items.forEach((item,index)=>{const itemDiv=document.createElement("div");itemDiv.className="bg-white p-4 rounded-lg shadow flex items-center gap-4",itemDiv.innerHTML=`<span class="font-bold text-lg text-teal-700">${index+1}.</span><button onclick="speak('${item.replace(/'/g,"\\'")}')" class="bg-teal-500 text-white rounded-full w-8 h-8 flex items-center justify-center shrink-0">▶</button><p class="dictation-answer-text answer-hidden text-lg flex-1">${item}</p>`,dictationArea.appendChild(itemDiv)}),resultsSection.classList.remove("hidden")
            }catch(error){
                console.error("받아쓰기 생성 오류:",error),errorSection.classList.remove("hidden"),document.getElementById("dictation-error-message").textContent=`오류가 발생했습니다: ${error.message}`
            }finally{
                loadingSection.classList.add("hidden")
            }
        }
        function revealDictationAnswers(){document.querySelectorAll(".dictation-answer-text").forEach(t=>{t.classList.remove("answer-hidden")})}
        
        // 책 만들기 로직
        async function generateBook(){
            isManualBookMode = false;
            const topic = document.getElementById('book-topic').value;
            const title = document.getElementById('book-title').value;
            const plot = document.getElementById('book-plot').value;
            const sheets = document.getElementById('book-sheets').value;
            const author = document.getElementById('book-author').value;
            const isEmptyContent = document.getElementById('empty-content-checkbox').checked;
            if (!topic || !title || !plot || !sheets || !author) { alert("모든 항목을 입력해주세요."); return; }
            if (sheets < 3) { alert("장 수는 3장 이상이어야 합니다."); return; }
            const loading = document.getElementById('book-loading-section'), error = document.getElementById('book-error-section');
            loading.classList.remove('hidden'); error.classList.add('hidden');
            try {
                const storyParts = await generateStory(topic, title, plot, sheets - 1);
                const imagePrompts = [title, ...storyParts];
                const images = await Promise.all(imagePrompts.map(p => generateImageForParagraph(p)));
                buildBookViewer(title, author, storyParts, images, isEmptyContent);
                showPage('book-viewer');
            } catch (err) {
                console.error("책 만들기 오류:", err);
                error.classList.remove('hidden');
                document.getElementById('book-error-message').textContent = `오류가 발생했습니다: ${err.message}`;
            } finally {
                loading.classList.add('hidden');
            }
        }
        function startManualBookCreation(){isManualBookMode=!0;buildBookViewer(null,null,[],[],!1);showPage("book-viewer")}
        function addManualPage(){const t=document.getElementById("book-viewer"),e=t.querySelectorAll(".book-spread").length,n=document.createElement("div");n.className="book-spread book-viewer",n.id=`spread-${e}`;const o=document.createElement("div");o.className="book-page bg-gray-200 border-r border-gray-300 flex items-center justify-center",o.innerHTML=`<span class="text-gray-400">그림이 생성될 곳</span><div class="page-number" style="left: 0.5rem;">${(e-1)*2+1}</div>`;const a=document.createElement("div");a.className="book-page bg-white",a.innerHTML=`<textarea class="manual-text-area" placeholder="여기에 이야기를 입력하세요..."></textarea><div class="page-number" style="right: 0.5rem;">${(e-1)*2+2}</div>`,n.appendChild(o),n.appendChild(a),t.insertBefore(n,document.getElementById("prev-page-btn")),totalBookSpreads++,changeBookPage(totalBookSpreads-1)}
        async function completeManualBook(){const t=document.querySelector("#manual-controls button:last-child");t.textContent="그림 생성 중...",t.disabled=!0;const e=document.getElementById("manual-book-context").value;try{const n=document.querySelector("#spread-0 .editable-text").textContent,o=await generateImageForParagraph(n,e);document.querySelector("#spread-0 .book-page:last-child").style.backgroundImage=`url('${o}')`;const a=document.querySelectorAll(".book-spread");for(let t=1;t<a.length;t++){const n=a[t].querySelector("textarea").value;if(n){const o=await generateImageForParagraph(n,e),i=a[t].querySelector(".book-page:first-child");i.style.backgroundImage=`url('${o}')`,i.innerHTML=`<div class="page-number" style="left: 0.5rem;">${2*(t-1)+1}</div>`}}alert("책이 완성되었습니다! 이제 글을 편집하거나 PDF로 저장할 수 있습니다."),t.textContent="그림 다시 만들기"}catch(t){console.error("수동 책 완성 오류:",t),alert(`그림 생성 중 오류가 발생했습니다: ${t.message}`),t.textContent="책 완성하기"}finally{t.disabled=!1}}
        async function generateStory(t,e,n,o){const a=`'${t}'를 주제로, 제목은 '${e}', 줄거리는 '${n}'인 동화책 이야기를 만들어줘. 이야기는 총 ${o}개의 문단으로 나누어줘. 각 문단은 어린이가 이해하기 쉬운 문체여야 해. 특히, 이야기의 마지막 문단은 모든 사건이 깔끔하게 마무리되는 결말이어야 해. 전체적인 구조는 기승전결(시작-전개-위기-절정-결말)을 따라야 해.`,i={contents:[{role:"user",parts:[{text:a}]}],generationConfig:{responseMimeType:"application/json",responseSchema:{type:"OBJECT",properties:{story_parts:{type:"ARRAY",items:{type:"STRING"}}},required:["story_parts"]}}},d=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!d.ok)throw new Error(`스토리 생성 API 오류: ${d.statusText}`);const r=await d.json(),s=JSON.parse(r.candidates[0].content.parts[0].text);if(!s.story_parts)throw new Error("스토리 생성 API로부터 유효한 데이터를 받지 못했습니다.");return s.story_parts}
        function buildBookViewer(t,e,n,o,a=!1){const i=document.getElementById("book-viewer");i.innerHTML="",document.getElementById("manual-controls").classList.toggle("hidden",!isManualBookMode),document.getElementById("standard-controls").classList.toggle("hidden",isManualBookMode),document.getElementById("manual-book-context-wrapper").classList.toggle("hidden",!isManualBookMode),document.getElementById("toggle-text-visibility-checkbox").checked=a;const d=a?"text-hidden":"";if(isManualBookMode)totalBookSpreads=1,i.innerHTML='<div id="spread-0" class="book-spread book-viewer active"><div class="book-page bg-white border-r border-gray-300"><div class="text-box"><h1 class="text-3xl font-bold editable-text" contenteditable="true">제목을 입력하세요</h1></div></div><div class="book-page bg-gray-200"><div class="absolute bottom-4 right-4 text-box"><p class="editable-text" contenteditable="true">글쓴이</p></div></div></div>';else{totalBookSpreads=1+n.length;for(let a=0;a<totalBookSpreads;a++){const r=document.createElement("div");r.className="book-spread book-viewer",r.id=`spread-${a}`;const s=document.createElement("div");if(s.className="book-page bg-white border-r border-gray-300",0===a)s.innerHTML=`<div class="text-box"><h1 class="text-3xl font-bold editable-text ${d}">${t}</h1></div>`;else{o[a]&&(s.style.backgroundImage=`url('${o[a]}')`),s.innerHTML+=`<div class="page-number" style="left: 0.5rem;">${2*(a-1)+1}</div>`}r.appendChild(s);const c=document.createElement("div");if(c.className="book-page bg-white",0===a)o[0]&&(c.style.backgroundImage=`url('${o[0]}')`),c.innerHTML=`<div class="text-box"><h1 class="text-3xl font-bold editable-text ${d}">${t}</h1></div><div class="absolute bottom-4 right-4 text-box"><p class="editable-text ${d}">${e}</p></div>`;else{const t=a-1;if(n[t]){const e=n[t],o=e.split(/\s+/).map(t=>`<span class="tts-word">${t}</span>`).join(" ");c.innerHTML=`<div class="h-full w-full flex items-center justify-center"><p class="text-xl leading-loose editable-text ${d}">${o}</p></div>`,c.innerHTML+=`<div class="page-number" style="right: 0.5rem;">${2*(a-1)+2}</div>`}}r.appendChild(c),i.appendChild(r)}}i.innerHTML+='<button id="prev-page-btn" onclick="changeBookPage(-1)" class="page-nav left-2">‹</button><button id="next-page-btn" onclick="changeBookPage(1)" class="page-nav right-2">›</button><button id="read-aloud-btn" onclick="readCurrentPage()" class="absolute top-4 right-4 bg-blue-500 text-white rounded-full w-10 h-10 flex items-center justify-center text-xl z-10">🔊</button>',bookCurrentPage=0,updateBookView()}
        function toggleTextVisibility(){const t=document.getElementById("toggle-text-visibility-checkbox").checked;document.querySelectorAll("#book-viewer .editable-text").forEach(e=>{e.classList.toggle("text-hidden",t)})}
        function changeBookPage(t){bookCurrentPage+=t,updateBookView()}
        function updateBookView(){document.querySelectorAll(".book-spread").forEach((t,e)=>{t.classList.toggle("active",e===bookCurrentPage)}),document.getElementById("prev-page-btn").style.display=0===bookCurrentPage?"none":"block",document.getElementById("next-page-btn").style.display=bookCurrentPage>=totalBookSpreads-1?"none":"block"}
        function readCurrentPage(){const t=document.getElementById(`spread-${bookCurrentPage}`);t&&speak(t.textContent.trim())}
        function toggleBookEdit(){const t=document.getElementById("edit-book-btn"),e="편집 완료"===t.textContent;document.querySelectorAll("#book-viewer .editable-text, #book-viewer .manual-text-area").forEach(t=>{t.contentEditable=!e,t.classList.toggle("outline-blue-500",!e),t.classList.toggle("outline",!e)}),t.textContent=e?"글 편집":"편집 완료",t.classList.toggle("bg-blue-500",e),t.classList.toggle("bg-red-500",!e)}
        async function downloadBookAsPDF(){const t=document.getElementById("save-book-pdf-btn");t.textContent="PDF 생성 중...",t.disabled=!0;const{jsPDF:e}=window,n=new e({orientation:"landscape",unit:"mm",format:"a4"}),o=document.querySelectorAll(".book-spread"),a=bookCurrentPage;for(let t=0;t<o.length;t++){t>0&&n.addPage("a4","l"),document.querySelectorAll(".book-spread").forEach(t=>{t.classList.remove("active")}),o[t].classList.add("active"),await new Promise(t=>setTimeout(t,50));const e=await html2canvas(o[t],{scale:2,useCORS:!0,backgroundColor:"#ffffff"});n.addImage(e.toDataURL("image/png"),"PNG",0,0,297,210)}n.save("AI_동화책.pdf"),document.querySelectorAll(".book-spread").forEach(t=>{t.classList.remove("active")}),o[a]&&o[a].classList.add("active"),t.textContent="PDF 저장",t.disabled=!1}
        document.addEventListener("click",t=>{const e=t.target;e.closest("#korean-page")?e.classList.contains("tts-word")?speak(e.textContent.trim()):e.matches(".korean-tts-btn")&&speak(e.getAttribute("data-text")):e.closest("#book-viewer-page")?e.classList.contains("tts-word")&&speak(e.textContent.trim()):e.closest("#math-page")&&e.classList.contains("tts-word")&&speak(e.textContent.trim().replace(/'/g,"\\'"))});
        async function generateKoreanWorksheet(){const t=document.getElementById("topic").value,e=document.getElementById("word_count").value;if(!t||!e)return void alert("주제와 글자 수를 모두 입력해주세요!");const n=document.getElementById("korean-loading-section"),o=document.getElementById("korean-error-section"),a=document.getElementById("korean-worksheet-area"),i=document.getElementById("korean-action-buttons");n.classList.remove("hidden"),o.classList.add("hidden"),a.innerHTML="",i.classList.add("hidden");try{const{title:d,paragraphs:r}=await generateText(t,e);a.innerHTML=`<div class="relative text-center mb-6"><button class="korean-tts-btn title-tts" data-text="${d}">▶</button><h2 class="text-2xl md:text-3xl font-bold">[${d}]</h2></div>`;const s=await Promise.all(r.map(async(t,e)=>{const n=await generateImageForParagraph(t),o=t.split(/\s+/).map(t=>`<span class="tts-word">${t}</span>`).join(" ");return`<div class="paragraph-block mb-8 relative"><button class="korean-tts-btn paragraph-tts" data-text="${t}">▶</button><p class="text-lg md:text-xl leading-relaxed bg-gray-50 p-4 rounded-lg"><strong>[${e+1}문단]</strong> ${o}</p><div class="flex justify-center my-4"><img src="${n}" alt="${topic} 관련 이미지" class="rounded-lg shadow-md max-w-sm w-full h-auto border-4 border-white"></div></div>`}));a.innerHTML+=s.join("");const c=r.join("\n\n"),l=await generateQuestions(c);let u='<div class="questions mt-10 p-6 bg-yellow-50 border-2 border-yellow-200 rounded-xl"><h3 class="text-xl md:text-2xl font-bold text-yellow-800 mb-4">💡 글을 읽고 질문에 답해 보아요!</h3><ol class="list-decimal list-inside space-y-3 text-lg text-gray-800">';l.forEach(t=>{const e=t.split(/\s+/).map(t=>`<span class="tts-word">${t}</span>`).join(" ");u+=`<li class="relative pl-2"><button class="korean-tts-btn question-tts" data-text="${t}">▶</button><p>${e}</p><textarea class="mt-2 w-full p-2 border border-gray-300 rounded-lg" rows="2" placeholder="답을 적어 보세요..."></textarea></li>`}),u+="</ol></div>",a.innerHTML+=u,i.classList.remove("hidden")}catch(t){console.error("국어 활동지 생성 오류:",t),o.classList.remove("hidden"),document.getElementById("korean-error-message").textContent=`오류가 발생했습니다: ${t.message}`}finally{n.classList.add("hidden")}}
        async function generateText(t,e){const n=`'${t}'라는 주제로 초등학생이 이해하기 쉽도록 약 ${e} 단어 분량의 글을 작성해 줘. 글은 반드시 총 4개의 문단으로 나누고, 각 문단의 내용은 명확하게 구분되어야 해. 전체 글에 대한 제목도 만들어줘.`,o={contents:[{role:"user",parts:[{text:n}]}],generationConfig:{responseMimeType:"application/json",responseSchema:{type:"OBJECT",properties:{title:{type:"STRING"},paragraphs:{type:"ARRAY",items:{type:"STRING"}}},required:["title","paragraphs"]}}},a=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!a.ok)throw new Error(`글 생성 API 오류: ${a.statusText}`);const i=await a.json();if(!i.candidates?.[0]?.content?.parts?.[0]?.text)throw new Error("글 생성 API로부터 유효한 데이터를 받지 못했습니다.");return JSON.parse(i.candidates[0].content.parts[0].text)}
        async function generateQuestions(t){const e="다음 글을 읽고, 초등학생 수준에서 글의 내용을 잘 이해했는지 확인할 수 있는 이해력 질문 4개를 만들어줘.",n={contents:[{role:"user",parts:[{text:e},{text:`글 내용:\n${t}`}]}],generationConfig:{responseMimeType:"application/json",responseSchema:{type:"OBJECT",properties:{questions:{type:"ARRAY",items:{type:"STRING"}}},required:["questions"]}}},o=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!o.ok)throw new Error(`질문 생성 API 오류: ${o.statusText}`);const a=await o.json();if(!a.candidates?.[0]?.content?.parts?.[0]?.text)throw new Error("질문 생성 API로부터 유효한 데이터를 받지 못했습니다.");return JSON.parse(a.candidates[0].content.parts[0].text).questions}
        function downloadPDF(t){const{jsPDF:e}=window,n=document.getElementById(t);html2canvas(n,{scale:2,useCORS:!0}).then(t=>{const n=t.toDataURL("image/png"),o=new e("p","mm","a4"),a=o.getImageProperties(n),i=o.internal.pageSize.getWidth(),d=a.height*i/a.width;o.addImage(n,"PNG",0,0,i,d),o.save("AI_활동지.pdf")})}
        async function generateMathProblems(){const t=document.getElementById("math-example").value,e=document.getElementById("math-count").value;if(!t||!e)return void alert("문제 예시와 문제 수를 모두 입력해주세요!");const n=document.getElementById("math-loading-section"),o=document.getElementById("math-error-section"),a=document.getElementById("math-problems-area"),i=document.getElementById("math-results-section");n.classList.remove("hidden"),o.classList.add("hidden"),a.innerHTML="",i.classList.add("hidden");try{const t=`'${document.getElementById("math-example").value}'와 비슷한 유형의 초등학생용 수학 문장제 문제를 ${document.getElementById("math-count").value}개 만들어줘. 각 문제에는 질문(problem)과 숫자 정답(answer)이 포함되어야 해.`,n={contents:[{role:"user",parts:[{text:t}]}],generationConfig:{responseMimeType:"application/json",responseSchema:{type:"ARRAY",items:{type:"OBJECT",properties:{problem:{type:"STRING"},answer:{type:"NUMBER"}},required:["problem","answer"]}}}},d=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!d.ok)throw new Error(`수학 문제 생성 API 오류: ${d.statusText}`);const r=await d.json();if(!r.candidates?.[0]?.content?.parts?.[0]?.text)throw new Error("수학 문제 생성 API로부터 유효한 데이터를 받지 못했습니다.");mathProblems=JSON.parse(r.candidates[0].content.parts[0].text),mathProblems.forEach((t,e)=>{t.status="pending";const n=t.problem.split(" ").map(t=>`<span class="tts-word">${t}</span>`).join(" "),o=document.createElement("div");o.className="bg-white p-5 rounded-lg shadow",o.innerHTML=`<div class="flex items-start gap-3"><div id="status-${e}" class="text-2xl font-bold text-rose-500 w-8 text-center pt-1">${e+1}.</div><div class="flex-1"><p class="text-xl mb-3">${n}</p><div class="flex items-center gap-3"><button onclick="speak('${t.problem.replace(/'/g,"\\'")}')" class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center shrink-0">▶</button><input id="answer-${e}" type="number" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="정답을 입력하세요"><button onclick="gradeSingleProblem(${e})" class="bg-rose-500 text-white py-2 px-4 rounded-lg whitespace-nowrap">채점</button></div></div></div>`,a.appendChild(o)}),i.classList.remove("hidden")}catch(t){console.error("수학 문제 생성 오류:",t),o.classList.remove("hidden"),document.getElementById("math-error-message").textContent=`오류가 발생했습니다: ${t.message}`}finally{n.classList.add("hidden")}}
        function gradeSingleProblem(t){const e=document.getElementById(`answer-${t}`).value;if(""===e)return void alert("답을 입력해주세요!");const n=mathProblems[t],o=document.getElementById(`status-${t}`);parseInt(e)===n.answer?(n.status="correct",o.innerHTML="<span class='text-green-500'>O</span>"):(n.status="incorrect",o.innerHTML="<span class='text-red-500'>X</span>")}
        function gradeAll(){let t=0;mathProblems.forEach((e,n)=>{if("correct"!==e.status)gradeSingleProblem(n);"correct"===mathProblems[n].status&&""!==document.getElementById(`answer-${n}`).value&&t++});const e=mathProblems.length>0?Math.round(t/mathProblems.length*100):0;document.getElementById("total-score").textContent=e}
        async function generateImageForParagraph(t,e=""){const n=e?`Crucial Context: ${e}.`:"",o=`Translate the following Korean text to English for an image generation prompt. Make it a simple, descriptive phrase. ${n} Page Text: "${t}"`,a={contents:[{role:"user",parts:[{text:o}]}]},i=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!i.ok)throw new Error(`번역 API 오류: ${i.statusText}`);const d=await i.json(),r=d.candidates[0].content.parts[0].text,s=`A very cute and simple children's book illustration, in the style of a cartoon, bright and soft colors, about: "${r}"`,c="stable-diffusion-xl-1024-v1-0",l="https://api.stability.ai",u=await fetch(`${l}/v1/generation/${c}/text-to-image`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Bearer ${STABILITY_API_KEY}`},body:JSON.stringify({text_prompts:[{text:s}],cfg_scale:7,height:1024,width:1024,samples:1,steps:30,style_preset:"comic-book"})});if(!u.ok)throw new Error(`이미지 생성 API 오류: ${u.statusText}`);const p=await u.json();if(!p.artifacts?.[0]?.base64)throw new Error("이미지 생성 API로부터 유효한 데이터를 받지 못했습니다.");return`data:image/png;base64,${p.artifacts[0].base64}`}
    </script>
</body>
</html>
