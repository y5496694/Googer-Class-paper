<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ì´ˆë“± í•™ìŠµì§€ & ì±… ë§Œë“¤ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap');
        body { font-family: 'Gowun Dodum', sans-serif; }
        .loader { border: 8px solid #f3f3f3; border-radius: 50%; width: 60px; height: 60px; animation: spin 2s linear infinite; }
        .loader.korean { border-top: 8px solid #3498db; }
        .loader.math { border-top: 8px solid #ef4444; }
        .loader.book { border-top: 8px solid #10b981; }
        .loader.dictation { border-top: 8px solid #14b8a6; }
        .loader.writing { border-top: 8px solid #8b5cf6; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .tts-word { cursor: pointer; transition: color 0.2s; }
        .tts-word:hover { color: #3b82f6; }
        
        .korean-tts-btn { position: absolute; left: -1.75rem; width: 1.5rem; height: 1.5rem; background-color: #3b82f6; color: white; border-radius: 9999px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; cursor: pointer; }
        .paragraph-tts { top: 0.5rem; }
        .question-tts { top: 0.25rem; }
        .title-tts { top: 0.5rem; }

        .book-viewer { aspect-ratio: 2 / 1.414; width: 100%; display: flex; }
        .book-page { position: relative; width: 50%; height: 100%; background-size: cover; background-position: center; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 2rem; box-sizing: border-box; }
        .book-spread { display: none; }
        .book-spread.active { display: flex; }
        .text-box { background-color: rgba(255, 255, 255, 0.85); border: 2px solid black; padding: 1rem; text-align: center; }
        .page-nav { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(0,0,0,0.5); color: white; border: none; border-radius: 9999px; width: 3rem; height: 3rem; font-size: 2rem; cursor: pointer; z-index: 10; }
        .page-number { position: absolute; bottom: 0.5rem; font-size: 0.875rem; color: #374151; }
        .manual-text-area { width: 100%; height: 80%; background: transparent; border: 2px dashed #ccc; border-radius: 8px; padding: 1rem; text-align: left; overflow-y: auto; }
        .text-hidden, .text-hidden .tts-word { color: transparent !important; }
        .text-box.text-hidden { background-color: rgba(255, 255, 255, 0) !important; border-color: transparent !important; }
        .answer-hidden { color: transparent; user-select: none; }
    </style>
</head>
<body class="p-2 md:p-8 bg-gray-100">

    <div id="app-container">
        <!-- êµ­ì–´ í™œë™ì§€ í˜ì´ì§€ -->
        <div id="korean-page" class="page-content max-w-4xl mx-auto">
             <div class="bg-white rounded-2xl shadow-lg p-6 md:p-10">
                <header class="flex flex-wrap justify-between items-center gap-4 mb-8">
                    <h1 class="text-2xl md:text-4xl font-bold text-gray-800">AI ì´ˆë“± êµ­ì–´ í™œë™ì§€</h1>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="showPage('dictation')" class="bg-teal-200 text-teal-700 font-bold py-2 px-4 rounded-lg hover:bg-teal-300 transition">AI ë°›ì•„ì“°ê¸° â†’</button>
                        <button onclick="showPage('writing')" class="bg-violet-200 text-violet-700 font-bold py-2 px-4 rounded-lg hover:bg-violet-300 transition">ì“°ê¸° í™œë™ì§€ â†’</button>
                        <button onclick="showPage('book-creator')" class="bg-emerald-200 text-emerald-700 font-bold py-2 px-4 rounded-lg hover:bg-emerald-300 transition">ì±… ë§Œë“¤ê¸° â†’</button>
                        <button onclick="showPage('math')" class="bg-rose-200 text-rose-700 font-bold py-2 px-4 rounded-lg hover:bg-rose-300 transition">AI ìˆ˜í•™ ë¬¸ì œ â†’</button>
                    </div>
                </header>
                <div id="korean-input-section" class="bg-blue-50 p-6 rounded-xl flex flex-col md:flex-row items-center gap-4">
                    <div class="w-full"><label for="topic" class="block text-lg font-semibold text-gray-700 mb-1">ê¸€ì˜ ì£¼ì œ</label><input type="text" id="topic" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ì˜ˆ: ìš°ì£¼, ê°•ì•„ì§€"></div>
                    <div class="w-full md:w-1/3"><label for="word_count" class="block text-lg font-semibold text-gray-700 mb-1">ë‹¨ì–´ ìˆ˜</label><input type="number" id="word_count" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ì˜ˆ: 200"></div>
                    <button id="korean-generate-btn" onclick="generateKoreanWorksheet()" class="w-full md:w-auto mt-4 md:mt-7 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg">í™œë™ì§€ ë§Œë“¤ê¸°</button>
                </div>
                <div id="korean-loading-section" class="text-center py-12 hidden"><div class="loader korean inline-block"></div><p class="text-lg text-gray-700 mt-4">AIê°€ ì—´ì‹¬íˆ ê¸€ì„ ì“°ê³  ê·¸ë¦¼ì„ ê·¸ë¦¬ê³  ìˆì–´ìš”...</p></div>
                <div id="korean-error-section" class="text-center py-8 hidden"><p class="text-xl text-red-600 font-semibold">ğŸ˜¥ ìƒì„± ì‹¤íŒ¨</p><p id="korean-error-message" class="text-gray-600 mt-2"></p></div>
                <div id="korean-worksheet-area" class="mt-8"></div>
                <div id="korean-action-buttons" class="text-center mt-10 hidden"><button id="download-pdf-korean" onclick="downloadPDF('korean-worksheet-area')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg">PDFë¡œ ì €ì¥í•˜ê¸°</button></div>
            </div>
        </div>

        <!-- ë°›ì•„ì“°ê¸° í˜ì´ì§€ -->
        <div id="dictation-page" class="page-content max-w-4xl mx-auto hidden">
            <div class="bg-teal-50 rounded-2xl shadow-lg p-6 md:p-10">
                <header class="flex justify-between items-center mb-8"><h1 class="text-2xl md:text-4xl font-bold text-teal-800">AI ë°›ì•„ì“°ê¸°</h1><button onclick="showPage('korean')" class="bg-blue-200 text-blue-700 font-bold py-2 px-4 rounded-lg hover:bg-blue-300 transition">â† AI êµ­ì–´ í™œë™ì§€</button></header>
                <div id="dictation-input-section" class="bg-white p-6 rounded-xl space-y-4">
                    <div class="flex justify-center gap-6 mb-4">
                        <label class="flex items-center text-lg"><input type="radio" name="dictationType" value="sentence" checked class="h-4 w-4 text-teal-600 border-gray-300 focus:ring-teal-500"><span class="ml-2">ë¬¸ì¥</span></label>
                        <label class="flex items-center text-lg"><input type="radio" name="dictationType" value="word" class="h-4 w-4 text-teal-600 border-gray-300 focus:ring-teal-500"><span class="ml-2">ë‹¨ì–´</span></label>
                    </div>
                    <div class="flex flex-col md:flex-row items-center gap-4">
                        <div class="w-full"><label for="dictation-topic" class="block text-lg font-semibold text-gray-700 mb-1">ë°›ì•„ì“°ê¸° ì£¼ì œ</label><input type="text" id="dictation-topic" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ì˜ˆ: ë™ë¬¼, ìš°ë¦¬ë‚˜ë¼"></div>
                        <div class="w-full md:w-1/3"><label for="dictation-count" class="block text-lg font-semibold text-gray-700 mb-1">ë¬¸í•­ ê°œìˆ˜</label><input type="number" id="dictation-count" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ì˜ˆ: 10"></div>
                        <button id="dictation-generate-btn" onclick="generateDictation()" class="w-full md:w-auto self-end bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-8 rounded-lg">ìƒì„±</button>
                    </div>
                </div>
                <div id="dictation-loading-section" class="text-center py-12 hidden"><div class="loader dictation inline-block"></div><p class="text-lg text-teal-700 mt-4">AIê°€ ë°›ì•„ì“°ê¸° ë¬¸ì œë¥¼ ë§Œë“¤ê³  ìˆì–´ìš”...</p></div>
                <div id="dictation-error-section" class="text-center py-8 hidden"><p class="text-xl text-red-600 font-semibold">ğŸ˜¥ ìƒì„± ì‹¤íŒ¨</p><p id="dictation-error-message" class="text-gray-600 mt-2"></p></div>
                <div id="dictation-area" class="mt-8 space-y-4"></div>
                <div id="dictation-results-section" class="mt-10 text-center hidden"><button onclick="revealDictationAnswers()" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-6 rounded-lg">ì •ë‹µ ê³µê°œ</button></div>
            </div>
        </div>

        <!-- ì“°ê¸° í™œë™ì§€ í˜ì´ì§€ (Placeholder) -->
        <div id="writing-page" class="page-content max-w-4xl mx-auto hidden">
            <div class="bg-violet-50 rounded-2xl shadow-lg p-6 md:p-10">
                <header class="flex justify-between items-center mb-8"><h1 class="text-2xl md:text-4xl font-bold text-violet-800">ì“°ê¸° í™œë™ì§€</h1><button onclick="showPage('korean')" class="bg-blue-200 text-blue-700 font-bold py-2 px-4 rounded-lg hover:bg-blue-300 transition">â† AI êµ­ì–´ í™œë™ì§€</button></header>
                <div class="text-center py-20">
                    <p class="text-2xl text-violet-700">ì´ ê¸°ëŠ¥ì€ í˜„ì¬ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. ğŸš€</p>
                </div>
            </div>
        </div>
        
        <!-- ìˆ˜í•™ ë¬¸ì œ í˜ì´ì§€ -->
        <div id="math-page" class="page-content max-w-4xl mx-auto hidden">
            <div class="bg-rose-50 rounded-2xl shadow-lg p-6 md:p-10">
                <header class="flex justify-between items-center mb-8"><h1 class="text-2xl md:text-4xl font-bold text-rose-800">AI ìˆ˜í•™ ë¬¸ì¥ì œ ë¬¸ì œ</h1><button onclick="showPage('korean')" class="bg-blue-200 text-blue-700 font-bold py-2 px-4 rounded-lg hover:bg-blue-300 transition">â† AI êµ­ì–´ í™œë™ì§€</button></header>
                <div id="math-input-section" class="bg-white p-6 rounded-xl flex flex-col md:flex-row items-center gap-4">
                     <div class="w-full"><label for="math-example" class="block text-lg font-semibold text-gray-700 mb-1">ë¬¸ì œ ì˜ˆì‹œ</label><input type="text" id="math-example" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ì˜ˆ: ì‚¬ê³¼ 3ê°œì™€ ë°° 2ê°œë¥¼ ë”í•˜ëŠ” ë¬¸ì œ"></div>
                    <div class="w-full md:w-1/3"><label for="math-count" class="block text-lg font-semibold text-gray-700 mb-1">ë¬¸ì œ ìˆ˜</label><input type="number" id="math-count" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ì˜ˆ: 5"></div>
                    <button id="math-generate-btn" onclick="generateMathProblems()" class="w-full md:w-auto mt-4 md:mt-7 bg-rose-600 hover:bg-rose-700 text-white font-bold py-3 px-8 rounded-lg">ë¬¸ì œ ë§Œë“¤ê¸°</button>
                </div>
                <div id="math-loading-section" class="text-center py-12 hidden"><div class="loader math inline-block"></div><p class="text-lg text-rose-700 mt-4">AIê°€ ì—´ì‹¬íˆ ë¬¸ì œë¥¼ ë§Œë“¤ê³  ìˆì–´ìš”...</p></div>
                <div id="math-error-section" class="text-center py-8 hidden"><p class="text-xl text-red-600 font-semibold">ğŸ˜¥ ìƒì„± ì‹¤íŒ¨</p><p id="math-error-message" class="text-gray-600 mt-2"></p></div>
                <div id="math-problems-area" class="mt-8 space-y-6"></div>
                <div id="math-results-section" class="mt-10 text-center hidden"><div class="bg-white inline-flex items-center gap-4 p-4 rounded-xl shadow"><span class="text-2xl font-bold text-rose-800">ì´ì : <span id="total-score">0</span>ì </span><button onclick="gradeAll()" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-6 rounded-lg">ì „ì²´ ì±„ì </button></div></div>
            </div>
        </div>
        
        <!-- ì±… ë§Œë“¤ê¸° í˜ì´ì§€ -->
        <div id="book-creator-page" class="page-content max-w-4xl mx-auto hidden">
             <div class="bg-emerald-50 rounded-2xl shadow-lg p-6 md:p-10">
                <header class="flex justify-between items-center mb-8"><h1 class="text-2xl md:text-4xl font-bold text-emerald-800">AI ë™í™”ì±… ë§Œë“¤ê¸°</h1><button onclick="showPage('korean')" class="bg-blue-200 text-blue-700 font-bold py-2 px-4 rounded-lg hover:bg-blue-300 transition">â† AI êµ­ì–´ í™œë™ì§€</button></header>
                <div id="book-input-section" class="bg-white p-6 rounded-xl space-y-4">
                    <p class="text-lg font-semibold text-gray-800">AIì—ê²Œ ë™í™”ì±… ì œì‘ì„ ë§¡ê²¨ë³´ì„¸ìš”!</p>
                    <div><label for="book-topic" class="block text-lg font-semibold text-gray-700 mb-1">ê¸€ì˜ ì£¼ì œ</label><input type="text" id="book-topic" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ì˜ˆ: ìš©ê°í•œ í† ë¼ì˜ ëª¨í—˜"></div>
                    <div><label for="book-title" class="block text-lg font-semibold text-gray-700 mb-1">ê¸€ì˜ ì œëª©</label><input type="text" id="book-title" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ì˜ˆ: ìˆ²ì†ì˜ ì‘ì€ ì˜ì›…"></div>
                    <div><label for="book-plot" class="block text-lg font-semibold text-gray-700 mb-1">ê°„ë‹¨í•œ ì¤„ê±°ë¦¬</label><textarea id="book-plot" class="w-full p-3 border border-gray-300 rounded-lg" rows="3" placeholder="ì˜ˆ: ì‘ì€ í† ë¼ê°€ ë¬´ì„œìš´ ëŠ‘ëŒ€ë¥¼ ê¾€ë¥¼ ë‚´ì–´ ë¬¼ë¦¬ì¹˜ê³  ìˆ²ì˜ ì˜ì›…ì´ ë˜ëŠ” ì´ì•¼ê¸°"></textarea></div>
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="w-full"><label for="book-sheets" class="block text-lg font-semibold text-gray-700 mb-1">ì¥ ìˆ˜ (3ì¥ ì´ìƒ)</label><input type="number" id="book-sheets" min="3" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ì˜ˆ: 5"></div>
                        <div class="w-full"><label for="book-author" class="block text-lg font-semibold text-gray-700 mb-1">ê¸€ì“´ì´</label><input type="text" id="book-author" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ì˜ˆ: í™ê¸¸ë™"></div>
                    </div>
                    <div class="mt-4 flex items-center">
                        <input id="empty-content-checkbox" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500">
                        <label for="empty-content-checkbox" class="ml-2 block text-sm text-gray-900">ë‚´ìš© ë¹„ìš°ê¸° ê¸°ëŠ¥ (ë‚´ìš© ì§ì ‘ ì¨ë³´ê¸°)</label>
                    </div>
                    <button id="book-generate-btn" onclick="generateBook()" class="w-full mt-2 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-8 rounded-lg">AIë¡œ ì±… ë§Œë“¤ê¸°</button>
                    <div class="border-t my-6"></div>
                    <p class="text-lg font-semibold text-gray-800">ë˜ëŠ”, ëª¨ë“  ë‚´ìš©ì„ ì§ì ‘ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>
                    <button onclick="startManualBookCreation()" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-8 rounded-lg">ë‚´ê°€ ì§ì ‘ ì±… ë§Œë“¤ê¸°</button>
                </div>
                <div id="book-loading-section" class="text-center py-12 hidden"><div class="loader book inline-block"></div><p class="text-lg text-emerald-700 mt-4">AIê°€ ë™í™”ì±…ì„ ë§Œë“¤ê³  ìˆì–´ìš”. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...</p></div>
                <div id="book-error-section" class="text-center py-8 hidden"><p class="text-xl text-red-600 font-semibold">ğŸ˜¥ ìƒì„± ì‹¤íŒ¨</p><p id="book-error-message" class="text-gray-600 mt-2"></p></div>
            </div>
        </div>

        <!-- ì±… ë·°ì–´ í˜ì´ì§€ -->
        <div id="book-viewer-page" class="page-content max-w-7xl mx-auto hidden">
            <div class="bg-white rounded-2xl shadow-lg p-4 md:p-6">
                <div id="viewer-controls" class="flex justify-between items-center mb-4">
                    <button onclick="showPage('book-creator')" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">â† ë’¤ë¡œ ê°€ê¸°</button>
                    <div id="manual-controls" class="hidden items-center gap-2">
                         <button onclick="addManualPage()" class="bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-600">+ í˜ì´ì§€ ì¶”ê°€</button>
                         <button onclick="completeManualBook()" class="bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-emerald-700">ì±… ì™„ì„±í•˜ê¸°</button>
                    </div>
                    <div id="standard-controls" class="flex items-center gap-4">
                        <div class="flex items-center">
                            <input id="toggle-text-visibility-checkbox" type="checkbox" onchange="toggleTextVisibility()" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="toggle-text-visibility-checkbox" class="ml-2 block text-sm text-gray-900">ë‚´ìš© ë¹„ìš°ê¸°</label>
                        </div>
                        <button id="edit-book-btn" onclick="toggleBookEdit()" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600">ê¸€ í¸ì§‘</button>
                        <button id="save-book-pdf-btn" onclick="downloadBookAsPDF()" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">PDF ì €ì¥</button>
                    </div>
                </div>
                <div id="book-viewer" class="relative"></div>
                <div id="manual-book-context-wrapper" class="hidden mt-4">
                    <label for="manual-book-context" class="block text-lg font-semibold text-gray-700 mb-2">ğŸ¨ ê·¸ë¦¼ ìƒì„±í•  ë•Œ AIê°€ ì•Œì•„ì•¼ í•  ë‚´ìš©</label>
                    <textarea id="manual-book-context" class="w-full p-3 border border-gray-300 rounded-lg" rows="3" placeholder="ì˜ˆ: ì±…ìƒ ì™•ìëŠ” ì‚¬ëŒì´ ì•„ë‹ˆë¼ ì±…ìƒì— ëˆˆ, ì½”, ì…ì´ ë‹¬ë¦° ì˜ì¸í™”ëœ ìƒë¬¼ì´ì•¼."></textarea>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GEMINI_API_KEY = "AIzaSyC7_Gq4LIVVMv0hMD6qSwcTlGJcDSt-KgI";
        const STABILITY_API_KEY = "sk-1O2c3lhxjfCfQizxRNllhxgEa8jJiNw01ebyzIOadQFFmdh1";
        const TEXT_MODEL = "gemini-2.0-flash";
        
        let mathProblems = [], bookCurrentPage = 0, totalBookSpreads = 0, isManualBookMode = false;

        function showPage(pageId) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            document.getElementById(`${pageId}-page`).classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ko-KR';
                utterance.rate = 0.9;
                window.speechSynthesis.speak(utterance);
            } else { alert("ìŒì„± ì§€ì›ì´ ë˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤."); }
        }

        // --- ë°›ì•„ì“°ê¸° ë¡œì§ ---
        async function generateDictation() {
            const topic = document.getElementById('dictation-topic').value;
            const count = document.getElementById('dictation-count').value;
            const type = document.querySelector('input[name="dictationType"]:checked').value;
            if (!topic || !count) { alert("ì£¼ì œì™€ ë¬¸í•­ ê°œìˆ˜ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!"); return; }

            const loadingSection = document.getElementById('dictation-loading-section');
            const errorSection = document.getElementById('dictation-error-section');
            const dictationArea = document.getElementById('dictation-area');
            const resultsSection = document.getElementById('dictation-results-section');

            loadingSection.classList.remove('hidden');
            errorSection.classList.add('hidden');
            dictationArea.innerHTML = '';
            resultsSection.classList.add('hidden');

            try {
                const prompt = type === 'sentence' 
                    ? `'${topic}'(ì´)ë¼ëŠ” ì£¼ì œë¡œ ì´ˆë“±í•™ìƒìš© ë°›ì•„ì“°ê¸° ë¬¸ì¥ì„ ${count}ê°œ ë§Œë“¤ì–´ì¤˜. ì§§ê³  ê°„ë‹¨í•œ ë¬¸ì¥ìœ¼ë¡œ ë¶€íƒí•´.`
                    : `'${topic}'(ì´)ë¼ëŠ” ì£¼ì œì™€ ê´€ë ¨ëœ, ì´ˆë“±í•™ìƒìš© ë°›ì•„ì“°ê¸° ë‹¨ì–´ë¥¼ ${count}ê°œ ë§Œë“¤ì–´ì¤˜.`;

                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: { type: "OBJECT", properties: { items: { type: "ARRAY", items: { type: "STRING" }}}, required: ["items"] }
                    }
                };
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`ë°›ì•„ì“°ê¸° ìƒì„± API ì˜¤ë¥˜: ${response.statusText}`);
                const result = await response.json();
                
                if (!result.candidates?.[0]?.content?.parts?.[0]?.text) throw new Error("ë°›ì•„ì“°ê¸° ìƒì„± APIë¡œë¶€í„° ìœ íš¨í•œ ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                const { items } = JSON.parse(result.candidates[0].content.parts[0].text);
                
                items.forEach((item, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'bg-white p-4 rounded-lg shadow flex items-center gap-4';
                    itemDiv.innerHTML = `
                        <span class="font-bold text-lg text-teal-700">${index + 1}.</span>
                        <button onclick="speak('${item.replace(/'/g, "\\'")}')" class="bg-teal-500 text-white rounded-full w-8 h-8 flex items-center justify-center shrink-0">â–¶</button>
                        <p class="dictation-answer-text answer-hidden text-lg flex-1">${item}</p>
                    `;
                    dictationArea.appendChild(itemDiv);
                });
                resultsSection.classList.remove('hidden');

            } catch (error) {
                console.error("ë°›ì•„ì“°ê¸° ìƒì„± ì˜¤ë¥˜:", error);
                errorSection.classList.remove('hidden');
                document.getElementById('dictation-error-message').textContent = `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`;
            } finally {
                loadingSection.classList.add('hidden');
            }
        }
        
        function revealDictationAnswers() {
            document.querySelectorAll('.dictation-answer-text').forEach(el => {
                el.classList.remove('answer-hidden');
            });
        }
        
        // --- (ì´í•˜ ë‚˜ë¨¸ì§€ ëª¨ë“  í•¨ìˆ˜ë“¤ì€ ì´ì „ ë²„ì „ê³¼ ë™ì¼) ---
        async function generateBook() {
            isManualBookMode = false;
            const topic = document.getElementById('book-topic').value, title = document.getElementById('book-title').value, plot = document.getElementById('book-plot').value, sheets = document.getElementById('book-sheets').value, author = document.getElementById('book-author').value, isEmptyContent = document.getElementById('empty-content-checkbox').checked;
            if (!topic || !title || !plot || !sheets || !author) { alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
            if (sheets < 3) { alert("ì¥ ìˆ˜ëŠ” 3ì¥ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤."); return; }
            const loading = document.getElementById('book-loading-section'), error = document.getElementById('book-error-section');
            loading.classList.remove('hidden'); error.classList.add('hidden');
            try {
                const storyParts = await generateStory(topic, title, plot, sheets - 1);
                const imagePrompts = [title, ...storyParts];
                const images = await Promise.all(imagePrompts.map(p => generateImageForParagraph(p)));
                buildBookViewer(title, author, storyParts, images, isEmptyContent);
                showPage('book-viewer');
            } catch (err) {
                console.error("ì±… ë§Œë“¤ê¸° ì˜¤ë¥˜:", err);
                error.classList.remove('hidden');
                document.getElementById('book-error-message').textContent = `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${err.message}`;
            } finally {
                loading.classList.add('hidden');
            }
        }
        function startManualBookCreation() {
            isManualBookMode = true;
            buildBookViewer(null, null, [], [], false);
            showPage('book-viewer');
        }
        function addManualPage() {
            const viewer = document.getElementById('book-viewer');
            const newSpreadIndex = viewer.querySelectorAll('.book-spread').length;
            const spread = document.createElement('div');
            spread.className = 'book-spread book-viewer';
            spread.id = `spread-${newSpreadIndex}`;
            const leftPage = document.createElement('div');
            leftPage.className = 'book-page bg-gray-200 border-r border-gray-300 flex items-center justify-center';
            leftPage.innerHTML = `<span class="text-gray-400">ê·¸ë¦¼ì´ ìƒì„±ë  ê³³</span><div class="page-number" style="left: 0.5rem;">${(newSpreadIndex -1) * 2 + 1}</div>`;
            const rightPage = document.createElement('div');
            rightPage.className = 'book-page bg-white';
            rightPage.innerHTML = `<textarea class="manual-text-area" placeholder="ì—¬ê¸°ì— ì´ì•¼ê¸°ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea><div class="page-number" style="right: 0.5rem;">${(newSpreadIndex - 1) * 2 + 2}</div>`;
            spread.appendChild(leftPage);
            spread.appendChild(rightPage);
            viewer.insertBefore(spread, document.getElementById('prev-page-btn'));
            totalBookSpreads++;
            changeBookPage(totalBookSpreads - 1);
        }
        async function completeManualBook() {
             const completeBtn = document.querySelector('#manual-controls button:last-child');
             completeBtn.textContent = 'ê·¸ë¦¼ ìƒì„± ì¤‘...'; completeBtn.disabled = true;
             const globalContext = document.getElementById('manual-book-context').value;
            try {
                const coverTitle = document.querySelector('#spread-0 .editable-text').textContent;
                const coverImage = await generateImageForParagraph(coverTitle, globalContext);
                document.querySelector('#spread-0 .book-page:last-child').style.backgroundImage = `url('${coverImage}')`;
                const spreads = document.querySelectorAll('.book-spread');
                for (let i = 1; i < spreads.length; i++) {
                    const text = spreads[i].querySelector('textarea').value;
                    if (text) {
                        const imageUrl = await generateImageForParagraph(text, globalContext);
                        const leftPage = spreads[i].querySelector('.book-page:first-child');
                        leftPage.style.backgroundImage = `url('${imageUrl}')`;
                        leftPage.innerHTML = `<div class="page-number" style="left: 0.5rem;">${(i - 1) * 2 + 1}</div>`;
                    }
                }
                alert('ì±…ì´ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ì´ì œ ê¸€ì„ í¸ì§‘í•˜ê±°ë‚˜ PDFë¡œ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                completeBtn.textContent = 'ê·¸ë¦¼ ë‹¤ì‹œ ë§Œë“¤ê¸°';
            } catch (err) {
                 console.error("ìˆ˜ë™ ì±… ì™„ì„± ì˜¤ë¥˜:", err);
                 alert(`ê·¸ë¦¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${err.message}`);
                 completeBtn.textContent = 'ì±… ì™„ì„±í•˜ê¸°';
            } finally {
                completeBtn.disabled = false;
            }
        }
        async function generateStory(topic, title, plot, storyPartCount) {
             const prompt = `'${topic}'ë¥¼ ì£¼ì œë¡œ, ì œëª©ì€ '${title}', ì¤„ê±°ë¦¬ëŠ” '${plot}'ì¸ ë™í™”ì±… ì´ì•¼ê¸°ë¥¼ ë§Œë“¤ì–´ì¤˜. ì´ì•¼ê¸°ëŠ” ì´ ${storyPartCount}ê°œì˜ ë¬¸ë‹¨ìœ¼ë¡œ ë‚˜ëˆ„ì–´ì¤˜. ê° ë¬¸ë‹¨ì€ ì–´ë¦°ì´ê°€ ì´í•´í•˜ê¸° ì‰¬ìš´ ë¬¸ì²´ì—¬ì•¼ í•´. íŠ¹íˆ, ì´ì•¼ê¸°ì˜ ë§ˆì§€ë§‰ ë¬¸ë‹¨ì€ ëª¨ë“  ì‚¬ê±´ì´ ê¹”ë”í•˜ê²Œ ë§ˆë¬´ë¦¬ë˜ëŠ” ê²°ë§ì´ì–´ì•¼ í•´. ì „ì²´ì ì¸ êµ¬ì¡°ëŠ” ê¸°ìŠ¹ì „ê²°(ì‹œì‘-ì „ê°œ-ìœ„ê¸°-ì ˆì •-ê²°ë§)ì„ ë”°ë¼ì•¼ í•´.`;
             const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { story_parts: { type: "ARRAY", items: { type: "STRING" }}}, required: ["story_parts"] }}};
             const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
             if (!response.ok) throw new Error(`ìŠ¤í† ë¦¬ ìƒì„± API ì˜¤ë¥˜: ${response.statusText}`);
             const result = await response.json();
             const parsedResult = JSON.parse(result.candidates[0].content.parts[0].text);
             if (!parsedResult.story_parts) throw new Error("ìŠ¤í† ë¦¬ ìƒì„± APIë¡œë¶€í„° ìœ íš¨í•œ ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
             return parsedResult.story_parts;
        }
        function buildBookViewer(title, author, storyParts, images, isEmptyContent = false) {
            const viewer = document.getElementById('book-viewer');
            viewer.innerHTML = '';
            document.getElementById('manual-controls').classList.toggle('hidden', !isManualBookMode);
            document.getElementById('standard-controls').classList.toggle('hidden', isManualBookMode);
            document.getElementById('manual-book-context-wrapper').classList.toggle('hidden', !isManualBookMode);
            document.getElementById('toggle-text-visibility-checkbox').checked = isEmptyContent;
            const textVisibilityClass = isEmptyContent ? 'text-hidden' : '';
            if (isManualBookMode) {
                 totalBookSpreads = 1;
                 viewer.innerHTML = `<div id="spread-0" class="book-spread book-viewer active"><div class="book-page bg-white border-r border-gray-300"><div class="text-box"><h1 class="text-3xl font-bold editable-text" contenteditable="true">ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”</h1></div></div><div class="book-page bg-gray-200"><div class="absolute bottom-4 right-4 text-box"><p class="editable-text" contenteditable="true">ê¸€ì“´ì´</p></div></div></div>`;
            } else {
                 totalBookSpreads = 1 + storyParts.length;
                 for (let i = 0; i < totalBookSpreads; i++) {
                    const spread = document.createElement('div');
                    spread.className = 'book-spread book-viewer'; spread.id = `spread-${i}`;
                    const leftPage = document.createElement('div');
                    leftPage.className = 'book-page bg-white border-r border-gray-300';
                    if (i === 0) { leftPage.innerHTML = `<div class="text-box"><h1 class="text-3xl font-bold editable-text ${textVisibilityClass}">${title}</h1></div>`; } 
                    else {
                        if(images[i]) leftPage.style.backgroundImage = `url('${images[i]}')`;
                        leftPage.innerHTML += `<div class="page-number" style="left: 0.5rem;">${(i - 1) * 2 + 1}</div>`;
                    }
                    spread.appendChild(leftPage);
                    const rightPage = document.createElement('div');
                    rightPage.className = 'book-page bg-white';
                    if (i === 0) {
                        if(images[0]) rightPage.style.backgroundImage = `url('${images[0]}')`;
                        rightPage.innerHTML = `<div class="text-box"><h1 class="text-3xl font-bold editable-text ${textVisibilityClass}">${title}</h1></div><div class="absolute bottom-4 right-4 text-box"><p class="editable-text ${textVisibilityClass}">${author}</p></div>`;
                    } else {
                        const storyIndex = i - 1;
                        if(storyParts[storyIndex]) {
                            const storyText = storyParts[storyIndex];
                            const wordSpans = storyText.split(/\s+/).map(w => `<span class="tts-word">${w}</span>`).join(' ');
                            rightPage.innerHTML = `<div class="h-full w-full flex items-center justify-center"><p class="text-xl leading-loose editable-text ${textVisibilityClass}">${wordSpans}</p></div>`;
                            rightPage.innerHTML += `<div class="page-number" style="right: 0.5rem;">${(i - 1) * 2 + 2}</div>`;
                        }
                    }
                    spread.appendChild(rightPage);
                    viewer.appendChild(spread);
                }
            }
            viewer.innerHTML += `<button id="prev-page-btn" onclick="changeBookPage(-1)" class="page-nav left-2">â€¹</button><button id="next-page-btn" onclick="changeBookPage(1)" class="page-nav right-2">â€º</button><button id="read-aloud-btn" onclick="readCurrentPage()" class="absolute top-4 right-4 bg-blue-500 text-white rounded-full w-10 h-10 flex items-center justify-center text-xl z-10">ğŸ”Š</button>`;
            bookCurrentPage = 0;
            updateBookView();
        }
        function toggleTextVisibility() { const isChecked = document.getElementById('toggle-text-visibility-checkbox').checked; document.querySelectorAll('#book-viewer .editable-text').forEach(el => { el.classList.toggle('text-hidden', isChecked); }); }
        function changeBookPage(direction) { bookCurrentPage += direction; updateBookView(); }
        function updateBookView() { document.querySelectorAll('.book-spread').forEach((s, i) => s.classList.toggle('active', i === bookCurrentPage)); document.getElementById('prev-page-btn').style.display = bookCurrentPage === 0 ? 'none' : 'block'; document.getElementById('next-page-btn').style.display = bookCurrentPage >= totalBookSpreads - 1 ? 'none' : 'block'; }
        function readCurrentPage() { const activeSpread = document.getElementById(`spread-${bookCurrentPage}`); if(activeSpread) speak(activeSpread.textContent.trim()); }
        function toggleBookEdit() { const btn = document.getElementById('edit-book-btn'); const isEditing = btn.textContent === 'í¸ì§‘ ì™„ë£Œ'; document.querySelectorAll('#book-viewer .editable-text, #book-viewer .manual-text-area').forEach(el => { el.contentEditable = !isEditing; el.classList.toggle('outline-blue-500', !isEditing); el.classList.toggle('outline', !isEditing); }); btn.textContent = isEditing ? 'ê¸€ í¸ì§‘' : 'í¸ì§‘ ì™„ë£Œ'; btn.classList.toggle('bg-blue-500', isEditing); btn.classList.toggle('bg-red-500', !isEditing); }
        async function downloadBookAsPDF() { const saveButton = document.getElementById('save-book-pdf-btn'); saveButton.textContent = 'PDF ìƒì„± ì¤‘...'; saveButton.disabled = true; const { jsPDF } = window.jspdf; const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' }); const spreads = document.querySelectorAll('.book-spread'); const originalActiveSpreadIndex = bookCurrentPage; for(let i = 0; i < spreads.length; i++) { if (i > 0) pdf.addPage('a4', 'l'); document.querySelectorAll('.book-spread').forEach(s => s.classList.remove('active')); spreads[i].classList.add('active'); await new Promise(resolve => setTimeout(resolve, 50)); const canvas = await html2canvas(spreads[i], { scale: 2, useCORS: true, backgroundColor: '#ffffff' }); pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 297, 210); } pdf.save('AI_ë™í™”ì±….pdf'); document.querySelectorAll('.book-spread').forEach(s => s.classList.remove('active')); if(spreads[originalActiveSpreadIndex]) { spreads[originalActiveSpreadIndex].classList.add('active'); } saveButton.textContent = 'PDF ì €ì¥'; saveButton.disabled = false; }
        document.addEventListener('click', (e) => { const target = e.target; if (target.closest('#korean-page')) { if (target.classList.contains('tts-word')) speak(target.textContent.trim()); else if (target.matches('.korean-tts-btn')) speak(target.getAttribute('data-text')); } else if (target.closest('#book-viewer-page')) { if (target.classList.contains('tts-word')) speak(target.textContent.trim()); } else if (target.closest('#math-page')) { if (target.classList.contains('tts-word')) speak(target.textContent.trim().replace(/'/g, "\\'")); } });
        async function generateKoreanWorksheet(){const topic=document.getElementById("topic").value,wordCount=document.getElementById("word_count").value;if(!topic||!wordCount)return void alert("ì£¼ì œì™€ ê¸€ì ìˆ˜ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!");const loadingSection=document.getElementById("korean-loading-section"),errorSection=document.getElementById("korean-error-section"),worksheetArea=document.getElementById("korean-worksheet-area"),actionButtons=document.getElementById("korean-action-buttons");loadingSection.classList.remove("hidden"),errorSection.classList.add("hidden"),worksheetArea.innerHTML="",actionButtons.classList.add("hidden");try{const{title:title,paragraphs:paragraphs}=await generateText(topic,wordCount);worksheetArea.innerHTML=`<div class="relative text-center mb-6"><button class="korean-tts-btn title-tts" data-text="${title}">â–¶</button><h2 class="text-2xl md:text-3xl font-bold">[${title}]</h2></div>`;const paragraphPromises=paragraphs.map(async(p,index)=>{const imageUrl=await generateImageForParagraph(p),wordSpans=p.split(/\s+/).map(w=>`<span class="tts-word">${w}</span>`).join(" ");return`<div class="paragraph-block mb-8 relative"><button class="korean-tts-btn paragraph-tts" data-text="${p}">â–¶</button><p class="text-lg md:text-xl leading-relaxed bg-gray-50 p-4 rounded-lg"><strong>[${index+1}ë¬¸ë‹¨]</strong> ${wordSpans}</p><div class="flex justify-center my-4"><img src="${imageUrl}" alt="${topic} ê´€ë ¨ ì´ë¯¸ì§€" class="rounded-lg shadow-md max-w-sm w-full h-auto border-4 border-white"></div></div>`}),paragraphHTMLs=await Promise.all(paragraphPromises);worksheetArea.innerHTML+=paragraphHTMLs.join("");const fullText=paragraphs.join("\n\n"),questions=await generateQuestions(fullText);let questionsHTML='<div class="questions mt-10 p-6 bg-yellow-50 border-2 border-yellow-200 rounded-xl"><h3 class="text-xl md:text-2xl font-bold text-yellow-800 mb-4">ğŸ’¡ ê¸€ì„ ì½ê³  ì§ˆë¬¸ì— ë‹µí•´ ë³´ì•„ìš”!</h3><ol class="list-decimal list-inside space-y-3 text-lg text-gray-800">';questions.forEach(q=>{const qWords=q.split(/\s+/).map(w=>`<span class="tts-word">${w}</span>`).join(" ");questionsHTML+=`<li class="relative pl-2"><button class="korean-tts-btn question-tts" data-text="${q}">â–¶</button><p>${qWords}</p><textarea class="mt-2 w-full p-2 border border-gray-300 rounded-lg" rows="2" placeholder="ë‹µì„ ì ì–´ ë³´ì„¸ìš”..."></textarea></li>`}),questionsHTML+="</ol></div>",worksheetArea.innerHTML+=questionsHTML,actionButtons.classList.remove("hidden")}catch(error){console.error("êµ­ì–´ í™œë™ì§€ ìƒì„± ì˜¤ë¥˜:",error),errorSection.classList.remove("hidden"),document.getElementById("korean-error-message").textContent=`ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`}finally{loadingSection.classList.add("hidden")}}async function generateText(topic,wordCount){const prompt=`'${topic}'ë¼ëŠ” ì£¼ì œë¡œ ì´ˆë“±í•™ìƒì´ ì´í•´í•˜ê¸° ì‰½ë„ë¡ ì•½ ${wordCount} ë‹¨ì–´ ë¶„ëŸ‰ì˜ ê¸€ì„ ì‘ì„±í•´ ì¤˜. ê¸€ì€ ë°˜ë“œì‹œ ì´ 4ê°œì˜ ë¬¸ë‹¨ìœ¼ë¡œ ë‚˜ëˆ„ê³ , ê° ë¬¸ë‹¨ì˜ ë‚´ìš©ì€ ëª…í™•í•˜ê²Œ êµ¬ë¶„ë˜ì–´ì•¼ í•´. ì „ì²´ ê¸€ì— ëŒ€í•œ ì œëª©ë„ ë§Œë“¤ì–´ì¤˜.`,payload={contents:[{role:"user",parts:[{text:prompt}]}],generationConfig:{responseMimeType:"application/json",responseSchema:{type:"OBJECT",properties:{title:{type:"STRING"},paragraphs:{type:"ARRAY",items:{type:"STRING"}}},required:["title","paragraphs"]}}},response=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});if(!response.ok)throw new Error(`ê¸€ ìƒì„± API ì˜¤ë¥˜: ${response.statusText}`);const result=await response.json();if(!result.candidates?.[0]?.content?.parts?.[0]?.text)throw new Error("ê¸€ ìƒì„± APIë¡œë¶€í„° ìœ íš¨í•œ ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");return JSON.parse(result.candidates[0].content.parts[0].text)}async function generateQuestions(fullText){const prompt="ë‹¤ìŒ ê¸€ì„ ì½ê³ , ì´ˆë“±í•™ìƒ ìˆ˜ì¤€ì—ì„œ ê¸€ì˜ ë‚´ìš©ì„ ì˜ ì´í•´í–ˆëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆëŠ” ì´í•´ë ¥ ì§ˆë¬¸ 4ê°œë¥¼ ë§Œë“¤ì–´ì¤˜.",payload={contents:[{role:"user",parts:[{text:prompt},{text:`ê¸€ ë‚´ìš©:\n${fullText}`}]}],generationConfig:{responseMimeType:"application/json",responseSchema:{type:"OBJECT",properties:{questions:{type:"ARRAY",items:{type:"STRING"}}},required:["questions"]}}},response=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});if(!response.ok)throw new Error(`ì§ˆë¬¸ ìƒì„± API ì˜¤ë¥˜: ${response.statusText}`);const result=await response.json();if(!result.candidates?.[0]?.content?.parts?.[0]?.text)throw new Error("ì§ˆë¬¸ ìƒì„± APIë¡œë¶€í„° ìœ íš¨í•œ ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");return JSON.parse(result.candidates[0].content.parts[0].text).questions}function downloadPDF(){const{jsPDF:jsPDF}=window,element=document.getElementById("korean-worksheet-area");html2canvas(element,{scale:2,useCORS:!0}).then(canvas=>{const imgData=canvas.toDataURL("image/png"),pdf=new jsPDF("p","mm","a4"),imgProps=pdf.getImageProperties(imgData),pdfWidth=pdf.internal.pageSize.getWidth(),pdfHeight=imgProps.height*pdfWidth/imgProps.width;pdf.addImage(imgData,"PNG",0,0,pdfWidth,pdfHeight),pdf.save("AI_êµ­ì–´_í™œë™ì§€.pdf")})}async function generateMathProblems(){const example=document.getElementById("math-example").value,count=document.getElementById("math-count").value;if(!example||!count)return void alert("ë¬¸ì œ ì˜ˆì‹œì™€ ë¬¸ì œ ìˆ˜ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!");const loadingSection=document.getElementById("math-loading-section"),errorSection=document.getElementById("math-error-section"),problemsArea=document.getElementById("math-problems-area"),resultsSection=document.getElementById("math-results-section");loadingSection.classList.remove("hidden"),errorSection.classList.add("hidden"),problemsArea.innerHTML="",resultsSection.classList.add("hidden");try{const prompt=`'${example}'ì™€ ë¹„ìŠ·í•œ ìœ í˜•ì˜ ì´ˆë“±í•™ìƒìš© ìˆ˜í•™ ë¬¸ì¥ì œ ë¬¸ì œë¥¼ ${count}ê°œ ë§Œë“¤ì–´ì¤˜. ê° ë¬¸ì œì—ëŠ” ì§ˆë¬¸(problem)ê³¼ ìˆ«ì ì •ë‹µ(answer)ì´ í¬í•¨ë˜ì–´ì•¼ í•´.`,payload={contents:[{role:"user",parts:[{text:prompt}]}],generationConfig:{responseMimeType:"application/json",responseSchema:{type:"ARRAY",items:{type:"OBJECT",properties:{problem:{type:"STRING"},answer:{type:"NUMBER"}},required:["problem","answer"]}}}},response=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});if(!response.ok)throw new Error(`ìˆ˜í•™ ë¬¸ì œ ìƒì„± API ì˜¤ë¥˜: ${response.statusText}`);const result=await response.json();if(!result.candidates?.[0]?.content?.parts?.[0]?.text)throw new Error("ìˆ˜í•™ ë¬¸ì œ ìƒì„± APIë¡œë¶€í„° ìœ íš¨í•œ ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");mathProblems=JSON.parse(result.candidates[0].content.parts[0].text),mathProblems.forEach((p,index)=>{p.status="pending";const wordsHTML=p.problem.split(" ").map(word=>`<span class="tts-word">${word}</span>`).join(" "),problemDiv=document.createElement("div");problemDiv.className="bg-white p-5 rounded-lg shadow",problemDiv.innerHTML=`<div class="flex items-start gap-3"><div id="status-${index}" class="text-2xl font-bold text-rose-500 w-8 text-center pt-1">${index+1}.</div><div class="flex-1"><p class="text-xl mb-3">${wordsHTML}</p><div class="flex items-center gap-3"><button onclick="speak('${p.problem.replace(/'/g,"\\'")}')" class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center shrink-0">â–¶</button><input id="answer-${index}" type="number" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”"><button onclick="gradeSingleProblem(${index})" class="bg-rose-500 text-white py-2 px-4 rounded-lg whitespace-nowrap">ì±„ì </button></div></div></div>`,problemsArea.appendChild(problemDiv)}),resultsSection.classList.remove("hidden")}catch(error){console.error("ìˆ˜í•™ ë¬¸ì œ ìƒì„± ì˜¤ë¥˜:",error),errorSection.classList.remove("hidden"),document.getElementById("math-error-message").textContent=`ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`}finally{loadingSection.classList.add("hidden")}}function gradeSingleProblem(index){const userAnswer=document.getElementById(`answer-${index}`).value;if(""===userAnswer)return void alert("ë‹µì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");const problem=mathProblems[index],statusDiv=document.getElementById(`status-${index}`);parseInt(userAnswer)===problem.answer?(problem.status="correct",statusDiv.innerHTML="ğŸ”´"):(problem.status="incorrect",statusDiv.innerHTML="â­")}function gradeAll(){let correctCount=0;mathProblems.forEach((p,index)=>{if("correct"!==p.status)gradeSingleProblem(index);"correct"===mathProblems[index].status&&""!==document.getElementById(`answer-${index}`).value&&correctCount++});const totalScore=mathProblems.length>0?Math.round(correctCount/mathProblems.length*100):0;document.getElementById("total-score").textContent=totalScore}async function generateImageForParagraph(paragraphText, globalContext = '') {
    const contextText = globalContext ? `Crucial Context: ${globalContext}.` : '';
    const translationPrompt = `Translate the following Korean text to English for an image generation prompt. Make it a simple, descriptive phrase. ${contextText} Page Text: "${paragraphText}"`;
    const translationPayload = {contents:[{role:"user",parts:[{text:translationPrompt}]}]},translationResponse=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(translationPayload)});if(!translationResponse.ok)throw new Error(`ë²ˆì—­ API ì˜¤ë¥˜: ${translationResponse.statusText}`);const translationResult=await translationResponse.json(),englishDescription=translationResult.candidates[0].content.parts[0].text,imagePrompt=`A very cute and simple children's book illustration, in the style of a cartoon, bright and soft colors, about: "${englishDescription}"`,engineId="stable-diffusion-xl-1024-v1-0",apiHost="https://api.stability.ai",response=await fetch(`${apiHost}/v1/generation/${engineId}/text-to-image`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Bearer ${STABILITY_API_KEY}`},body:JSON.stringify({text_prompts:[{text:imagePrompt}],cfg_scale:7,height:1024,width:1024,samples:1,steps:30,style_preset:"comic-book"})});if(!response.ok)throw new Error(`ì´ë¯¸ì§€ ìƒì„± API ì˜¤ë¥˜: ${response.statusText}`);const responseJSON=await response.json();if(!responseJSON.artifacts?.[0]?.base64)throw new Error("ì´ë¯¸ì§€ ìƒì„± APIë¡œë¶€í„° ìœ íš¨í•œ ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");return`data:image/png;base64,${responseJSON.artifacts[0].base64}`}
    </script>
</body>
</html>
