<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ì´ˆë“± í•™ìŠµì§€ & ì±… ë§Œë“¤ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap');
        body { font-family: 'Gowun Dodum', sans-serif; }
        .loader { border: 8px solid #f3f3f3; border-radius: 50%; width: 60px; height: 60px; animation: spin 2s linear infinite; }
        .loader.korean { border-top: 8px solid #3498db; }
        .loader.math { border-top: 8px solid #ef4444; }
        .loader.book { border-top: 8px solid #10b981; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .tts-word { cursor: pointer; transition: color 0.2s; }
        .tts-word:hover { color: #3b82f6; }
        
        .korean-tts-btn { position: absolute; left: -1.75rem; width: 1.5rem; height: 1.5rem; background-color: #3b82f6; color: white; border-radius: 9999px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; cursor: pointer; }
        .paragraph-tts { top: 0.5rem; }
        .question-tts { top: 0.25rem; }
        .title-tts { top: 0.5rem; }

        /* Book Viewer Styles */
        .book-viewer { aspect-ratio: 2 / 1.414; /* A4 ê°€ë¡œ ë¹„ìœ¨ */ width: 100%; display: flex; }
        .book-page { width: 50%; height: 100%; background-size: cover; background-position: center; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 2rem; box-sizing: border-box; }
        .book-spread { display: none; }
        .book-spread.active { display: flex; }
        .text-box { background-color: rgba(255, 255, 255, 0.85); border: 2px solid black; padding: 1rem; text-align: center; }
        .page-nav { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(0,0,0,0.5); color: white; border: none; border-radius: 9999px; width: 3rem; height: 3rem; font-size: 2rem; cursor: pointer; z-index: 10; }
    </style>
</head>
<body class="p-2 md:p-8 bg-gray-100">

    <!-- í˜ì´ì§€ ì»¨í…Œì´ë„ˆ -->
    <div id="app-container">
        <!-- êµ­ì–´ í™œë™ì§€ í˜ì´ì§€ -->
        <div id="korean-page" class="page-content max-w-4xl mx-auto">
             <div class="bg-white rounded-2xl shadow-lg p-6 md:p-10">
                <header class="flex flex-wrap justify-between items-center gap-4 mb-8">
                    <h1 class="text-2xl md:text-4xl font-bold text-gray-800">AI ì´ˆë“± êµ­ì–´ í™œë™ì§€</h1>
                    <div class="flex gap-2">
                        <button onclick="showPage('book-creator')" class="bg-emerald-200 text-emerald-700 font-bold py-2 px-4 rounded-lg hover:bg-emerald-300 transition">ì±… ë§Œë“¤ê¸° â†’</button>
                        <button onclick="showPage('math')" class="bg-rose-200 text-rose-700 font-bold py-2 px-4 rounded-lg hover:bg-rose-300 transition">AI ìˆ˜í•™ ë¬¸ì œ â†’</button>
                    </div>
                </header>
                <div id="korean-input-section" class="bg-blue-50 p-6 rounded-xl flex flex-col md:flex-row items-center gap-4">
                    <div class="w-full"><label for="topic" class="block text-lg font-semibold text-gray-700 mb-1">ê¸€ì˜ ì£¼ì œ</label><input type="text" id="topic" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ì˜ˆ: ìš°ì£¼, ê°•ì•„ì§€"></div>
                    <div class="w-full md:w-1/3"><label for="word_count" class="block text-lg font-semibold text-gray-700 mb-1">ë‹¨ì–´ ìˆ˜</label><input type="number" id="word_count" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ì˜ˆ: 200"></div>
                    <button id="korean-generate-btn" onclick="generateKoreanWorksheet()" class="w-full md:w-auto mt-4 md:mt-7 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg">í™œë™ì§€ ë§Œë“¤ê¸°</button>
                </div>
                <div id="korean-loading-section" class="text-center py-12 hidden"><div class="loader korean inline-block"></div><p class="text-lg text-gray-700 mt-4">AIê°€ ì—´ì‹¬íˆ ê¸€ì„ ì“°ê³  ê·¸ë¦¼ì„ ê·¸ë¦¬ê³  ìˆì–´ìš”...</p></div>
                <div id="korean-error-section" class="text-center py-8 hidden"><p class="text-xl text-red-600 font-semibold">ğŸ˜¥ ìƒì„± ì‹¤íŒ¨</p><p id="korean-error-message" class="text-gray-600 mt-2"></p></div>
                <div id="korean-worksheet-area" class="mt-8"></div>
                <div id="korean-action-buttons" class="text-center mt-10 hidden"><button id="download-pdf" onclick="downloadPDF()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg">PDFë¡œ ì €ì¥í•˜ê¸°</button></div>
            </div>
        </div>

        <!-- ìˆ˜í•™ ë¬¸ì œ í˜ì´ì§€ -->
        <div id="math-page" class="page-content max-w-4xl mx-auto hidden">
            <div class="bg-rose-50 rounded-2xl shadow-lg p-6 md:p-10">
                <header class="flex justify-between items-center mb-8"><h1 class="text-2xl md:text-4xl font-bold text-rose-800">AI ìˆ˜í•™ ë¬¸ì¥ì œ ë¬¸ì œ</h1><button onclick="showPage('korean')" class="bg-blue-200 text-blue-700 font-bold py-2 px-4 rounded-lg hover:bg-blue-300 transition">â† AI êµ­ì–´ í™œë™ì§€</button></header>
                <div id="math-input-section" class="bg-white p-6 rounded-xl flex flex-col md:flex-row items-center gap-4">
                    <div class="w-full"><label for="math-example" class="block text-lg font-semibold text-gray-700 mb-1">ë¬¸ì œ ì˜ˆì‹œ</label><input type="text" id="math-example" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ì˜ˆ: ì‚¬ê³¼ 3ê°œì™€ ë°° 2ê°œë¥¼ ë”í•˜ëŠ” ë¬¸ì œ"></div>
                    <div class="w-full md:w-1/3"><label for="math-count" class="block text-lg font-semibold text-gray-700 mb-1">ë¬¸ì œ ìˆ˜</label><input type="number" id="math-count" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ì˜ˆ: 5"></div>
                    <button id="math-generate-btn" onclick="generateMathProblems()" class="w-full md:w-auto mt-4 md:mt-7 bg-rose-600 hover:bg-rose-700 text-white font-bold py-3 px-8 rounded-lg">ë¬¸ì œ ë§Œë“¤ê¸°</button>
                </div>
                <div id="math-loading-section" class="text-center py-12 hidden"><div class="loader math inline-block"></div><p class="text-lg text-rose-700 mt-4">AIê°€ ì—´ì‹¬íˆ ë¬¸ì œë¥¼ ë§Œë“¤ê³  ìˆì–´ìš”...</p></div>
                <div id="math-error-section" class="text-center py-8 hidden"><p class="text-xl text-red-600 font-semibold">ğŸ˜¥ ìƒì„± ì‹¤íŒ¨</p><p id="math-error-message" class="text-gray-600 mt-2"></p></div>
                <div id="math-problems-area" class="mt-8 space-y-6"></div>
                <div id="math-results-section" class="mt-10 text-center hidden"><div class="bg-white inline-flex items-center gap-4 p-4 rounded-xl shadow"><span class="text-2xl font-bold text-rose-800">ì´ì : <span id="total-score">0</span>ì </span><button onclick="gradeAll()" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-6 rounded-lg">ì „ì²´ ì±„ì </button></div></div>
            </div>
        </div>
        
        <!-- ì±… ë§Œë“¤ê¸° í˜ì´ì§€ -->
        <div id="book-creator-page" class="page-content max-w-4xl mx-auto hidden">
             <div class="bg-emerald-50 rounded-2xl shadow-lg p-6 md:p-10">
                <header class="flex justify-between items-center mb-8"><h1 class="text-2xl md:text-4xl font-bold text-emerald-800">AI ë™í™”ì±… ë§Œë“¤ê¸°</h1><button onclick="showPage('korean')" class="bg-blue-200 text-blue-700 font-bold py-2 px-4 rounded-lg hover:bg-blue-300 transition">â† AI êµ­ì–´ í™œë™ì§€</button></header>
                <div id="book-input-section" class="bg-white p-6 rounded-xl space-y-4">
                    <div><label for="book-topic" class="block text-lg font-semibold text-gray-700 mb-1">ê¸€ì˜ ì£¼ì œ</label><input type="text" id="book-topic" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ì˜ˆ: ìš©ê°í•œ í† ë¼ì˜ ëª¨í—˜"></div>
                    <div><label for="book-title" class="block text-lg font-semibold text-gray-700 mb-1">ê¸€ì˜ ì œëª©</label><input type="text" id="book-title" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ì˜ˆ: ìˆ²ì†ì˜ ì‘ì€ ì˜ì›…"></div>
                    <div><label for="book-plot" class="block text-lg font-semibold text-gray-700 mb-1">ê°„ë‹¨í•œ ì¤„ê±°ë¦¬</label><textarea id="book-plot" class="w-full p-3 border border-gray-300 rounded-lg" rows="3" placeholder="ì˜ˆ: ì‘ì€ í† ë¼ê°€ ë¬´ì„œìš´ ëŠ‘ëŒ€ë¥¼ ê¾€ë¥¼ ë‚´ì–´ ë¬¼ë¦¬ì¹˜ê³  ìˆ²ì˜ ì˜ì›…ì´ ë˜ëŠ” ì´ì•¼ê¸°"></textarea></div>
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="w-full"><label for="book-pages" class="block text-lg font-semibold text-gray-700 mb-1">í˜ì´ì§€ ìˆ˜ (3ì¥ ì´ìƒ)</label><input type="number" id="book-pages" min="3" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ì˜ˆ: 5"></div>
                        <div class="w-full"><label for="book-author" class="block text-lg font-semibold text-gray-700 mb-1">ê¸€ì“´ì´</label><input type="text" id="book-author" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ì˜ˆ: í™ê¸¸ë™"></div>
                    </div>
                    <button id="book-generate-btn" onclick="generateBook()" class="w-full mt-4 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-8 rounded-lg">ì±… ë§Œë“¤ê¸°</button>
                </div>
                <div id="book-loading-section" class="text-center py-12 hidden"><div class="loader book inline-block"></div><p class="text-lg text-emerald-700 mt-4">AIê°€ ë™í™”ì±…ì„ ë§Œë“¤ê³  ìˆì–´ìš”. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...</p></div>
                <div id="book-error-section" class="text-center py-8 hidden"><p class="text-xl text-red-600 font-semibold">ğŸ˜¥ ìƒì„± ì‹¤íŒ¨</p><p id="book-error-message" class="text-gray-600 mt-2"></p></div>
            </div>
        </div>

        <!-- ì±… ë·°ì–´ í˜ì´ì§€ -->
        <div id="book-viewer-page" class="page-content max-w-7xl mx-auto hidden">
            <div class="bg-white rounded-2xl shadow-lg p-4 md:p-6">
                <div class="flex justify-between items-center mb-4">
                    <button onclick="showPage('book-creator')" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">â† ë’¤ë¡œ ê°€ê¸°</button>
                    <div class="flex gap-2">
                        <button id="edit-book-btn" onclick="toggleBookEdit()" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600">ê¸€ í¸ì§‘</button>
                        <button id="save-book-pdf-btn" onclick="downloadBookAsPDF()" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">PDF ì €ì¥</button>
                    </div>
                </div>
                <div id="book-viewer" class="relative">
                    <!-- ì±… ë‚´ìš©ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- ì „ì—­ ë³€ìˆ˜ ë° ì´ˆê¸° ì„¤ì • ---
        const GEMINI_API_KEY = "AIzaSyC7_Gq4LIVVMv0hMD6qSwcTlGJcDSt-KgI";
        const STABILITY_API_KEY = "sk-1O2c3lhxjfCfQizxRNllhxgEa8jJiNw01ebyzIOadQFFmdh1";
        const TEXT_MODEL = "gemini-2.0-flash";
        
        let mathProblems = [];
        let bookCurrentPage = 0;
        let totalBookSpreads = 0;

        // --- í˜ì´ì§€ ì „í™˜ ë° ê³µí†µ UI í•¨ìˆ˜ ---
        function showPage(pageId) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            document.getElementById(pageId + '-page').classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ko-KR';
                utterance.rate = 0.9;
                window.speechSynthesis.speak(utterance);
            } else { alert("ìŒì„± ì§€ì›ì´ ë˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤."); }
        }

        // --- êµ­ì–´ í™œë™ì§€ ë¡œì§ (ê¸°ì¡´ê³¼ ë™ì¼) ---
        // generateKoreanWorksheet, generateText, generateQuestions, downloadPDF ...

        // --- ìˆ˜í•™ ë¬¸ì œ ë¡œì§ (ê¸°ì¡´ê³¼ ë™ì¼) ---
        // generateMathProblems, gradeSingleProblem, gradeAll ...
        
        // --- ì±… ë§Œë“¤ê¸° ë¡œì§ ---
        async function generateBook() {
            const topic = document.getElementById('book-topic').value;
            const title = document.getElementById('book-title').value;
            const plot = document.getElementById('book-plot').value;
            const pages = document.getElementById('book-pages').value;
            const author = document.getElementById('book-author').value;

            if (!topic || !title || !plot || !pages || !author) { alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
            if (pages < 3) { alert("í˜ì´ì§€ ìˆ˜ëŠ” 3ì¥ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤."); return; }

            const loading = document.getElementById('book-loading-section');
            const error = document.getElementById('book-error-section');
            loading.classList.remove('hidden');
            error.classList.add('hidden');

            try {
                const storyParts = await generateStory(topic, title, plot, pages - 1); // í‘œì§€ ì œì™¸
                
                const imagePrompts = [title, ...storyParts]; // í‘œì§€ ì´ë¯¸ì§€ + ê° í˜ì´ì§€ ì´ë¯¸ì§€
                const imagePromises = imagePrompts.map(prompt => generateImageForParagraph(prompt));
                const images = await Promise.all(imagePromises);

                buildBookViewer(title, author, storyParts, images);
                showPage('book-viewer');

            } catch (err) {
                console.error("ì±… ë§Œë“¤ê¸° ì˜¤ë¥˜:", err);
                error.classList.remove('hidden');
                document.getElementById('book-error-message').textContent = `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${err.message}`;
            } finally {
                loading.classList.add('hidden');
            }
        }
        
        async function generateStory(topic, title, plot, pageCount) {
             const prompt = `'${topic}'ë¥¼ ì£¼ì œë¡œ, ì œëª©ì€ '${title}', ì¤„ê±°ë¦¬ëŠ” '${plot}'ì¸ ë™í™”ì±… ì´ì•¼ê¸°ë¥¼ ë§Œë“¤ì–´ì¤˜. ì´ì•¼ê¸°ëŠ” ì´ ${pageCount}ê°œì˜ ë¬¸ë‹¨ìœ¼ë¡œ ë‚˜ëˆ„ì–´ì¤˜. ê° ë¬¸ë‹¨ì€ ì–´ë¦°ì´ê°€ ì´í•´í•˜ê¸° ì‰¬ìš´ ë¬¸ì²´ì—¬ì•¼ í•´.`;
             const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { story_parts: { type: "ARRAY", items: { type: "STRING" }}}, required: ["story_parts"] }}};
             const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
             if (!response.ok) throw new Error(`ìŠ¤í† ë¦¬ ìƒì„± API ì˜¤ë¥˜: ${response.statusText}`);
             const result = await response.json();
             if (!result.candidates?.[0]?.content?.parts?.[0]?.text) throw new Error("ìŠ¤í† ë¦¬ ìƒì„± APIë¡œë¶€í„° ìœ íš¨í•œ ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
             return JSON.parse(result.candidates[0].content.parts[0].text).story_parts;
        }
        
        function buildBookViewer(title, author, storyParts, images) {
            const viewer = document.getElementById('book-viewer');
            viewer.innerHTML = ''; // Clear previous book
            
            const totalPages = 1 + storyParts.length; // 1 cover + story pages
            totalBookSpreads = Math.ceil(totalPages / 2);

            let pageCounter = 0;
            
            for (let i = 0; i < totalBookSpreads; i++) {
                const spread = document.createElement('div');
                spread.className = 'book-spread book-viewer';
                spread.id = `spread-${i}`;

                // Left Page
                const leftPage = document.createElement('div');
                leftPage.className = 'book-page bg-white border-r border-gray-300';
                if (i === 0) { // í‘œì§€ ì™¼ìª½
                    leftPage.innerHTML = `<div class="text-box"><h1 class="text-3xl font-bold editable-text">${title}</h1></div>`;
                } else { // ë‚´ìš© ì™¼ìª½ (ê·¸ë¦¼)
                    const imgIndex = i; // 2ë²ˆì§¸ ì¥ ê·¸ë¦¼ = images[1], 3ë²ˆì§¸ ì¥ ê·¸ë¦¼ = images[2]
                    if(images[imgIndex]) leftPage.style.backgroundImage = `url('${images[imgIndex]}')`;
                }
                spread.appendChild(leftPage);
                
                // Right Page
                const rightPage = document.createElement('div');
                rightPage.className = 'book-page bg-white';
                if (i === 0) { // í‘œì§€ ì˜¤ë¥¸ìª½
                    rightPage.style.backgroundImage = `url('${images[0]}')`;
                    rightPage.innerHTML = `
                        <div class="text-box"><h1 class="text-3xl font-bold editable-text">${title}</h1></div>
                        <div class="absolute bottom-4 right-4 text-box"><p class="editable-text">${author}</p></div>
                    `;
                } else { // ë‚´ìš© ì˜¤ë¥¸ìª½ (ê¸€)
                    const storyIndex = i - 1;
                    if(storyParts[storyIndex]) {
                        const storyText = storyParts[storyIndex];
                        const wordSpans = storyText.split(/\s+/).map(w => `<span class="tts-word">${w}</span>`).join(' ');
                        rightPage.innerHTML = `<div class="h-full w-full flex items-center justify-center"><p class="text-xl leading-loose editable-text">${wordSpans}</p></div>`;
                    }
                }
                spread.appendChild(rightPage);
                
                viewer.appendChild(spread);
            }
            
            // ë„¤ë¹„ê²Œì´ì…˜ ë° ì½ê¸° ë²„íŠ¼ ì¶”ê°€
            viewer.innerHTML += `
                <button id="prev-page-btn" onclick="changeBookPage(-1)" class="page-nav left-2">â€¹</button>
                <button id="next-page-btn" onclick="changeBookPage(1)" class="page-nav right-2">â€º</button>
                <button id="read-aloud-btn" onclick="readCurrentPage()" class="absolute top-4 right-4 bg-blue-500 text-white rounded-full w-10 h-10 flex items-center justify-center text-xl z-10">ğŸ”Š</button>
            `;

            bookCurrentPage = 0;
            updateBookView();
        }

        function changeBookPage(direction) {
            bookCurrentPage += direction;
            updateBookView();
        }

        function updateBookView() {
            document.querySelectorAll('.book-spread').forEach((s, i) => {
                s.classList.toggle('active', i === bookCurrentPage);
            });
            document.getElementById('prev-page-btn').style.display = bookCurrentPage === 0 ? 'none' : 'block';
            document.getElementById('next-page-btn').style.display = bookCurrentPage === totalBookSpreads - 1 ? 'none' : 'block';
        }

        function readCurrentPage() {
            const activeSpread = document.getElementById(`spread-${bookCurrentPage}`);
            if(activeSpread) {
                speak(activeSpread.textContent.trim());
            }
        }
        
        function toggleBookEdit() {
            const btn = document.getElementById('edit-book-btn');
            const isEditing = btn.textContent === 'í¸ì§‘ ì™„ë£Œ';
            const editables = document.querySelectorAll('#book-viewer .editable-text');
            
            editables.forEach(el => {
                el.contentEditable = !isEditing;
                el.classList.toggle('outline-blue-500', !isEditing);
                el.classList.toggle('outline', !isEditing);
            });
            
            btn.textContent = isEditing ? 'ê¸€ í¸ì§‘' : 'í¸ì§‘ ì™„ë£Œ';
            btn.classList.toggle('bg-blue-500', isEditing);
            btn.classList.toggle('hover:bg-blue-600', isEditing);
            btn.classList.toggle('bg-red-500', !isEditing);
            btn.classList.toggle('hover:bg-red-600', !isEditing);
        }
        
        async function downloadBookAsPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
            const spreads = document.querySelectorAll('.book-spread');
            
            for(let i = 0; i < spreads.length; i++) {
                const spread = spreads[i];
                if (i > 0) pdf.addPage();
                
                // html2canvasë¡œ spreadë¥¼ ìº¡ì²˜
                const canvas = await html2canvas(spread, { scale: 2, useCORS: true, backgroundColor: null });
                const imgData = canvas.toDataURL('image/png');
                
                // A4 ê°€ë¡œ í¬ê¸°: 297x210 mm
                pdf.addImage(imgData, 'PNG', 0, 0, 297, 210);
            }
            pdf.save('AI_ë™í™”ì±….pdf');
        }
        
        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í†µí•© (í˜ì´ì§€ë³„) ---
        document.addEventListener('click', (e) => {
            const target = e.target;
            const koreanPage = target.closest('#korean-page');
            const mathPage = target.closest('#math-page');
            const bookPage = target.closest('#book-viewer-page');

            if (koreanPage) {
                if (target.classList.contains('tts-word')) speak(target.textContent.trim());
                else if (target.matches('.korean-tts-btn')) speak(target.getAttribute('data-text'));
            } else if (bookPage) {
                if (target.classList.contains('tts-word')) speak(target.textContent.trim());
            }
        });
        
        // ì—¬ê¸°ì— ê¸°ì¡´ êµ­ì–´/ìˆ˜í•™/ì´ë¯¸ì§€ ìƒì„± í•¨ìˆ˜ë“¤ì„ ë¶™ì—¬ë„£ê¸°...
        // generateKoreanWorksheet, generateText, generateQuestions, downloadPDF...
        // generateMathProblems, gradeSingleProblem, gradeAll...
        // generateImageForParagraph...
        
        // --- (ì´í•˜ ìƒëµëœ ê¸°ì¡´ í•¨ìˆ˜ë“¤) ---
        // ì•„ë˜ëŠ” ê³µê°„ ì ˆì•½ì„ ìœ„í•´ ìƒëµëœ ê¸°ì¡´ í•¨ìˆ˜ë“¤ì…ë‹ˆë‹¤.
        // ì‹¤ì œ ì‚¬ìš©ì‹œì—ëŠ” ì´ì „ì— ì œê³µëœ ì½”ë“œë¥¼ ì—¬ê¸°ì— ëª¨ë‘ í¬í•¨ì‹œì¼œì•¼ í•©ë‹ˆë‹¤.
        // ê¸°ì¡´ êµ­ì–´/ìˆ˜í•™/ì´ë¯¸ì§€ ìƒì„± í•¨ìˆ˜ê°€ ì—¬ê¸°ì— ìˆë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.

    </script>
    <script>
    // ì´ ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ì— ì´ì „ ì½”ë“œì˜ ë‚˜ë¨¸ì§€ í•¨ìˆ˜ë“¤ì„ ëª¨ë‘ ë³µì‚¬í•˜ì—¬ ë¶™ì—¬ë„£ìŠµë‹ˆë‹¤.
    // êµ­ì–´ í™œë™ì§€ ë¡œì§
    async function generateKoreanWorksheet() {
        const topic = document.getElementById('topic').value;
        const wordCount = document.getElementById('word_count').value;
        if (!topic || !wordCount) { alert("ì£¼ì œì™€ ê¸€ì ìˆ˜ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!"); return; }

        const loadingSection = document.getElementById('korean-loading-section');
        const errorSection = document.getElementById('korean-error-section');
        const worksheetArea = document.getElementById('korean-worksheet-area');
        const actionButtons = document.getElementById('korean-action-buttons');

        loadingSection.classList.remove('hidden');
        errorSection.classList.add('hidden');
        worksheetArea.innerHTML = '';
        actionButtons.classList.add('hidden');
        
        try {
            const { title, paragraphs } = await generateText(topic, wordCount);
            worksheetArea.innerHTML = `<div class="relative text-center mb-6"><button class="korean-tts-btn title-tts" data-text="${title}">â–¶</button><h2 class="text-2xl md:text-3xl font-bold">[${title}]</h2></div>`;

            const paragraphPromises = paragraphs.map(async (p, index) => {
                const imageUrl = await generateImageForParagraph(p);
                const wordSpans = p.split(/\s+/).map(w => `<span class="tts-word">${w}</span>`).join(' ');
                return `<div class="paragraph-block mb-8 relative"><button class="korean-tts-btn paragraph-tts" data-text="${p}">â–¶</button><p class="text-lg md:text-xl leading-relaxed bg-gray-50 p-4 rounded-lg"><strong>[${index + 1}ë¬¸ë‹¨]</strong> ${wordSpans}</p><div class="flex justify-center my-4"><img src="${imageUrl}" alt="${topic} ê´€ë ¨ ì´ë¯¸ì§€" class="rounded-lg shadow-md max-w-sm w-full h-auto border-4 border-white"></div></div>`;
            });
            const paragraphHTMLs = await Promise.all(paragraphPromises);
            worksheetArea.innerHTML += paragraphHTMLs.join('');

            const fullText = paragraphs.join('\n\n');
            const questions = await generateQuestions(fullText);

            let questionsHTML = `<div class="questions mt-10 p-6 bg-yellow-50 border-2 border-yellow-200 rounded-xl"><h3 class="text-xl md:text-2xl font-bold text-yellow-800 mb-4">ğŸ’¡ ê¸€ì„ ì½ê³  ì§ˆë¬¸ì— ë‹µí•´ ë³´ì•„ìš”!</h3><ol class="list-decimal list-inside space-y-3 text-lg text-gray-800">`;
            questions.forEach(q => {
                const qWords = q.split(/\s+/).map(w => `<span class="tts-word">${w}</span>`).join(' ');
                questionsHTML += `<li class="relative pl-2"><button class="korean-tts-btn question-tts" data-text="${q}">â–¶</button><p>${qWords}</p><textarea class="mt-2 w-full p-2 border border-gray-300 rounded-lg" rows="2" placeholder="ë‹µì„ ì ì–´ ë³´ì„¸ìš”..."></textarea></li>`;
            });
            questionsHTML += `</ol></div>`;
            worksheetArea.innerHTML += questionsHTML;
            actionButtons.classList.remove('hidden');
        } catch (error) {
            console.error("êµ­ì–´ í™œë™ì§€ ìƒì„± ì˜¤ë¥˜:", error);
            errorSection.classList.remove('hidden');
            document.getElementById('korean-error-message').textContent = `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`;
        } finally {
            loadingSection.classList.add('hidden');
        }
    }
    async function generateText(topic, wordCount) {
        const prompt = `'${topic}'ë¼ëŠ” ì£¼ì œë¡œ ì´ˆë“±í•™ìƒì´ ì´í•´í•˜ê¸° ì‰½ë„ë¡ ì•½ ${wordCount} ë‹¨ì–´ ë¶„ëŸ‰ì˜ ê¸€ì„ ì‘ì„±í•´ ì¤˜. ê¸€ì€ ë°˜ë“œì‹œ ì´ 4ê°œì˜ ë¬¸ë‹¨ìœ¼ë¡œ ë‚˜ëˆ„ê³ , ê° ë¬¸ë‹¨ì˜ ë‚´ìš©ì€ ëª…í™•í•˜ê²Œ êµ¬ë¶„ë˜ì–´ì•¼ í•´. ì „ì²´ ê¸€ì— ëŒ€í•œ ì œëª©ë„ ë§Œë“¤ì–´ì¤˜.`;
        const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { title: { type: "STRING" }, paragraphs: { type: "ARRAY", items: { type: "STRING" } } }, required: ["title", "paragraphs"] } } };
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!response.ok) throw new Error(`ê¸€ ìƒì„± API ì˜¤ë¥˜: ${response.statusText}`);
        const result = await response.json();
        if (!result.candidates?.[0]?.content?.parts?.[0]?.text) throw new Error("ê¸€ ìƒì„± APIë¡œë¶€í„° ìœ íš¨í•œ ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        return JSON.parse(result.candidates[0].content.parts[0].text);
    }
    async function generateQuestions(fullText) {
        const prompt = `ë‹¤ìŒ ê¸€ì„ ì½ê³ , ì´ˆë“±í•™ìƒ ìˆ˜ì¤€ì—ì„œ ê¸€ì˜ ë‚´ìš©ì„ ì˜ ì´í•´í–ˆëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆëŠ” ì´í•´ë ¥ ì§ˆë¬¸ 4ê°œë¥¼ ë§Œë“¤ì–´ì¤˜.`;
        const payload = { contents: [{ role: "user", parts: [{ text: prompt }, { text: `ê¸€ ë‚´ìš©:\n${fullText}` }] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { questions: { type: "ARRAY", items: { type: "STRING" } } }, required: ["questions"] } } };
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!response.ok) throw new Error(`ì§ˆë¬¸ ìƒì„± API ì˜¤ë¥˜: ${response.statusText}`);
        const result = await response.json();
        if (!result.candidates?.[0]?.content?.parts?.[0]?.text) throw new Error("ì§ˆë¬¸ ìƒì„± APIë¡œë¶€í„° ìœ íš¨í•œ ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        return JSON.parse(result.candidates[0].content.parts[0].text).questions;
    }
    function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const element = document.getElementById('korean-worksheet-area');
        html2canvas(element, { scale: 2, useCORS: true }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4');
            const imgProps= pdf.getImageProperties(imgData);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            pdf.save('AI_êµ­ì–´_í™œë™ì§€.pdf');
        });
    }
    // ìˆ˜í•™ ë¬¸ì œ ë¡œì§
    async function generateMathProblems() {
        const example = document.getElementById('math-example').value;
        const count = document.getElementById('math-count').value;
        if (!example || !count) { alert("ë¬¸ì œ ì˜ˆì‹œì™€ ë¬¸ì œ ìˆ˜ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!"); return; }

        const loadingSection = document.getElementById('math-loading-section');
        const errorSection = document.getElementById('math-error-section');
        const problemsArea = document.getElementById('math-problems-area');
        const resultsSection = document.getElementById('math-results-section');

        loadingSection.classList.remove('hidden');
        errorSection.classList.add('hidden');
        problemsArea.innerHTML = '';
        resultsSection.classList.add('hidden');

        try {
            const prompt = `'${example}'ì™€ ë¹„ìŠ·í•œ ìœ í˜•ì˜ ì´ˆë“±í•™ìƒìš© ìˆ˜í•™ ë¬¸ì¥ì œ ë¬¸ì œë¥¼ ${count}ê°œ ë§Œë“¤ì–´ì¤˜. ê° ë¬¸ì œì—ëŠ” ì§ˆë¬¸(problem)ê³¼ ìˆ«ì ì •ë‹µ(answer)ì´ í¬í•¨ë˜ì–´ì•¼ í•´.`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "ARRAY", items: { type: "OBJECT", properties: { problem: { type: "STRING" }, answer: { type: "NUMBER" } }, required: ["problem", "answer"] } } } };
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`ìˆ˜í•™ ë¬¸ì œ ìƒì„± API ì˜¤ë¥˜: ${response.statusText}`);
            const result = await response.json();
            
            if (!result.candidates?.[0]?.content?.parts?.[0]?.text) throw new Error("ìˆ˜í•™ ë¬¸ì œ ìƒì„± APIë¡œë¶€í„° ìœ íš¨í•œ ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            mathProblems = JSON.parse(result.candidates[0].content.parts[0].text);
            
            mathProblems.forEach((p, index) => {
                p.status = 'pending';
                const wordsHTML = p.problem.split(' ').map(word => `<span class="tts-word" onclick="speak('${word.replace(/'/g, "\\'")}');">${word}</span>`).join(' ');
                
                const problemDiv = document.createElement('div');
                problemDiv.className = 'bg-white p-5 rounded-lg shadow';
                problemDiv.innerHTML = `<div class="flex items-start gap-3"><div id="status-${index}" class="text-2xl font-bold text-rose-500 w-8 text-center pt-1">${index + 1}.</div><div class="flex-1"><p class="text-xl mb-3">${wordsHTML}</p><div class="flex items-center gap-3"><button onclick="speak('${p.problem.replace(/'/g, "\\'")}')" class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center shrink-0">â–¶</button><input id="answer-${index}" type="number" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”"><button onclick="gradeSingleProblem(${index})" class="bg-rose-500 text-white py-2 px-4 rounded-lg whitespace-nowrap">ì±„ì </button></div></div></div>`;
                problemsArea.appendChild(problemDiv);
            });
            resultsSection.classList.remove('hidden');

        } catch (error) {
            console.error("ìˆ˜í•™ ë¬¸ì œ ìƒì„± ì˜¤ë¥˜:", error);
            errorSection.classList.remove('hidden');
            document.getElementById('math-error-message').textContent = `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`;
        } finally {
            loadingSection.classList.add('hidden');
        }
    }
    function gradeSingleProblem(index) {
        const userAnswer = document.getElementById(`answer-${index}`).value;
        if (userAnswer === '') { alert('ë‹µì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
        const problem = mathProblems[index];
        const statusDiv = document.getElementById(`status-${index}`);
        if (parseInt(userAnswer) === problem.answer) {
            problem.status = 'correct';
            statusDiv.innerHTML = 'ğŸ”´';
        } else {
            problem.status = 'incorrect';
            statusDiv.innerHTML = 'â­';
        }
    }
    function gradeAll() {
        let correctCount = 0;
        mathProblems.forEach((p, index) => {
            if (p.status !== 'correct') { gradeSingleProblem(index); }
            if (document.getElementById(`answer-${index}`).value !== '' && mathProblems[index].status === 'correct') { correctCount++; }
        });
        const totalScore = mathProblems.length > 0 ? Math.round((correctCount / mathProblems.length) * 100) : 0;
        document.getElementById('total-score').textContent = totalScore;
    }
    // ê³µìš© ì´ë¯¸ì§€ ìƒì„± ë¡œì§
    async function generateImageForParagraph(paragraphText) {
        const translationPrompt = `Translate the following Korean text to English for an image generation prompt. Make it a simple, descriptive phrase. Korean text: "${paragraphText}"`;
        const translationPayload = { contents: [{ role: "user", parts: [{ text: translationPrompt }] }] };
        const translationResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${GEMINI_API_KEY}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(translationPayload) });
        if (!translationResponse.ok) throw new Error(`ë²ˆì—­ API ì˜¤ë¥˜: ${translationResponse.statusText}`);
        const translationResult = await translationResponse.json();
        const englishDescription = translationResult.candidates[0].content.parts[0].text;
        
        const imagePrompt = `A very cute and simple children's book illustration, in the style of a cartoon, bright and soft colors, about: "${englishDescription}"`;
        const engineId = 'stable-diffusion-xl-1024-v1-0';
        const apiHost = 'https://api.stability.ai';
        const response = await fetch(`${apiHost}/v1/generation/${engineId}/text-to-image`, { method: 'POST', headers: { 'Content-Type': 'application/json', Accept: 'application/json', Authorization: `Bearer ${STABILITY_API_KEY}`, }, body: JSON.stringify({ text_prompts: [{ text: imagePrompt }], cfg_scale: 7, height: 1024, width: 1024, samples: 1, steps: 30, style_preset: "comic-book" }), });
        if (!response.ok) throw new Error(`ì´ë¯¸ì§€ ìƒì„± API ì˜¤ë¥˜: ${response.statusText}`);
        const responseJSON = await response.json();
        if (!responseJSON.artifacts?.[0]?.base64) throw new Error("ì´ë¯¸ì§€ ìƒì„± APIë¡œë¶€í„° ìœ íš¨í•œ ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        return `data:image/png;base64,${responseJSON.artifacts[0].base64}`;
    }
    </script>
</body>
</html>

